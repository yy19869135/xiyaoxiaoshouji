<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>NovaOS - å¾®åšç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* æ‰€æœ‰CSSæ ·å¼ */
        body {
            overscroll-behavior: none;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        #screen {
            background-image: url('https://i.postimg.cc/mPffwVnm');
            background-size: cover;
            background-position: center;
        }
        .app-icon-label {
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        .ios-scroll {
            -webkit-overflow-scrolling: touch;
        }
        .app-screen {
            transition: transform 0.35s cubic-bezier(0.25, 1, 0.5, 1);
            transform: translateX(100%);
            z-index: 10;
        }
        .app-screen.active {
            transform: translateX(0);
        }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .slide-up { animation: slideUp 0.35s cubic-bezier(0.2, 0.8, 0.2, 1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { translateY(0); } }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        #unlock-slider-track {
            background: rgba(255, 255, 255, 0.2);
            -webkit-mask-image: -webkit-linear-gradient(left, transparent 0%, black 25%, black 75%, transparent 100%);
            mask-image: linear-gradient(to right, transparent 0%, black 25%, black 75%, transparent 100%);
        }
        #unlock-slider-text {
            color: #fff;
            mix-blend-mode: plus-lighter;
            background: linear-gradient(90deg, #555, #fff, #555);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shimmer 2.5s linear infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% center; }
            100% { background-position: -200% center; }
        }

        .password-dot {
            transition: background-color 0.2s ease;
        }
        .password-dot.filled {
            background-color: white;
        }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        .setting-item {
             background-color: white;
             padding: 1rem;
             display: flex;
             justify-content: space-between;
             align-items: center;
             cursor: pointer;
        }
        .setting-item:not(:last-child) {
            border-bottom: 1px solid #f0f0f0;
        }
        .setting-item:hover {
            background-color: #f7f7f7;
        }

        #connection-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            transition: background-color 0.3s;
        }
        #connection-status-dot.idle { background-color: #9ca3af; }
        #connection-status-dot.testing { background-color: #f59e0b; animation: pulse 1.5s infinite; }
        #connection-status-dot.connected { background-color: #22c55e; }
        #connection-status-dot.failed { background-color: #ef4444; }

        @keyframes pulse {
          0%, 100% { opacity: 1; }
          50% { opacity: 0.5; }
        }

        #chat-sidebar {
    position: absolute; /* ç¡®ä¿å®ƒèƒ½è¦†ç›–åœ¨èŠå¤©ç•Œé¢ä¸Š */
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.3); /* ç»™èƒŒæ™¯ä¸€ä¸ªåŠé€æ˜çš„é®ç½©ï¼Œæ„Ÿè§‰æ›´çœŸå® */
    z-index: 55; /* å±‚çº§è¦æ¯”èŠå¤©ç•Œé¢é«˜ï¼Œä½†å¯ä»¥æ¯”çŠ¶æ€æ ä½ */
    transition: opacity 0.3s ease; /* æŠŠåŠ¨ç”»ä»æ»‘åŠ¨æ”¹ä¸ºæ·¡å…¥æ·¡å‡º */
    opacity: 0; /* é»˜è®¤æ˜¯é€æ˜çš„ */
    pointer-events: none; /* é»˜è®¤ä¸å¯ç‚¹å‡»ï¼Œé˜²æ­¢æŒ¡ä½ä¸‹é¢çš„å†…å®¹ */
}

#chat-sidebar.active {
    opacity: 1; /* æ¿€æ´»æ—¶å˜ä¸ºä¸é€æ˜ */
    pointer-events: auto; /* æ¿€æ´»æ—¶å¯ç‚¹å‡» */
}

/* è¿™æ˜¯ä¾§è¾¹æ çœŸæ­£çš„ç™½è‰²å†…å®¹æ¡† */
#chat-sidebar > div {
    position: absolute;
    top: 0;
    right: 0;
    width: 80%; /* å å±å¹•å®½åº¦çš„80% */
    height: 100%;
    padding-top: 44px; /* å…³é”®ï¼è¿™é‡Œç•™å‡ºçŠ¶æ€æ çš„é«˜åº¦ï¼Œ44pxçº¦ç­‰äº11rem */
    background-color: white;
    box-shadow: -5px 0 15px rgba(0,0,0,0.1);
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
}

#chat-sidebar.active > div {
    transform: translateX(0); /* æ¿€æ´»æ—¶æ»‘å…¥ */
}

        #chat-sidebar.active {
            transform: translateX(0);
        }

        .category-tab {
            transition: all 0.2s ease;
        }
        .category-tab.active {
            background-color: #3b82f6;
            color: white;
        }

        .worldbook-entry {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .worldbook-entry:hover {
            background-color: #f8fafc;
        }
        .worldbook-entry.selected {
            border-left: 4px solid #3b82f6;
        }

        .bound-entry {
            background-color: #f0f9ff;
            border-left: 4px solid #3b82f6;
        }

        .avatar-upload-container {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        .avatar-upload-container:hover::after {
            content: 'æ›´æ¢å¤´åƒ';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 12px;
        }
        .sidebar-section {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .member-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .member-item:hover {
            background-color: #f8f9fa;
        }
        .member-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 12px;
        }
        .member-info {
            flex: 1;
        }
        .member-name {
            font-weight: 500;
            font-size: 14px;
        }
        .member-role {
            font-size: 12px;
            color: #6c757d;
        }
        .remove-member-btn {
            color: #dc3545;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            background: none;
            border: none;
            cursor: pointer;
        }
        .remove-member-btn:hover {
            background-color: #f8d7da;
        }
        .bound-entry-item {
            background: #e7f3ff;
            border-left: 3px solid #0d6efd;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .bound-entry-title {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 4px;
        }
        .bound-entry-category {
            font-size: 12px;
            color: #6c757d;
        }
        .unbind-btn {
            color: #dc3545;
            font-size: 12px;
            background: none;
            border: none;
            cursor: pointer;
            margin-top: 8px;
        }
        .chat-mode-indicator {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .online-mode {
            background: #d1edff;
            color: #0d6efd;
        }
        .offline-mode {
            background: #e2e3e5;
            color: #6c757d;
        }
    </style>
</head>
<body class="bg-gray-800 flex items-center justify-center min-h-screen">

    <div id="phone-container" class="bg-black rounded-[50px] p-2.5 shadow-2xl overflow-hidden" style="width: 393px; height: 760px;">
        <div id="screen" class="relative w-full h-full rounded-[40px] overflow-hidden">

            <!-- çŠ¶æ€æ  -->
            <div id="status-bar" class="absolute top-0 left-0 w-full h-11 px-6 flex justify-between items-center z-50 text-white">
                <span id="time-display" class="font-semibold text-sm"></span>
                <div class="flex items-center space-x-1">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M17 4h3v16h-3V4zM4 15h3v5H4v-5zm6-5h3v10h-3V10z"></path></svg>
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M22 8.5c0-.83-.67-1.5-1.5-1.5H19V6c0-1.1-.9-2-2-2h-1c-.55 0-1 .45-1 1s.45 1 1 1h1v1h-1.5c-.83 0-1.5.67-1.5 1.5V16c0 .83.67 1.5 1.5 1.5H19v1c0 .55.45 1 1 1h1c1.1 0 2-.9 2-2v-1.5h1.5c.83 0 1.5-.67 1.5-1.5v-3c0-.83-.67-1.5-1.5-1.5z"></path></svg>
                </div>
            </div>

            <!-- é”å± -->
            <div id="lock-screen" class="absolute inset-0 w-full h-full flex flex-col justify-center items-center text-white z-40 backdrop-blur-md bg-black/30">
                <div class="flex-grow flex flex-col items-center justify-center -mt-16">
                    <div id="lock-time" class="text-8xl font-thin"></div>
                    <div id="lock-date" class="text-xl font-light mt-1"></div>
                </div>
                <div id="slide-unlock-container" class="w-full pb-12"><div id="unlock-slider-track" class="relative w-64 h-12 rounded-full mx-auto flex items-center justify-center"><div id="unlock-slider-thumb" class="absolute left-1 top-1 w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center cursor-pointer"><svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg></div><span id="unlock-slider-text" class="text-lg font-medium">æ»‘åŠ¨æ¥è§£é”</span></div></div>
                <div id="password-unlock-container" class="hidden w-full pb-8 flex flex-col items-center"><p id="password-prompt" class="text-lg mb-4">è¾“å…¥å¯†ç </p><div id="password-display" class="flex space-x-4 mb-8"><div class="password-dot w-3 h-3 border border-white/50 rounded-full"></div><div class="password-dot w-3 h-3 border border-white/50 rounded-full"></div><div class="password-dot w-3 h-3 border border-white/50 rounded-full"></div><div class="password-dot w-3 h-3 border border-white/50 rounded-full"></div></div><div id="keypad" class="grid grid-cols-3 gap-x-8 gap-y-3"></div></div>
                <div id="gesture-unlock-container" class="hidden w-full pb-8 flex flex-col items-center"><p id="gesture-prompt" class="text-lg mb-4 text-center"></p><canvas id="gesture-canvas" class="touch-none" width="280" height="280"></canvas></div>
            </div>

            <!-- ä¸»å±å¹• -->
            <div id="home-screen" class="hidden absolute inset-0 w-full h-full flex flex-col pt-16 px-4 pb-4">
                <div id="app-grid" class="flex-grow grid grid-cols-4 gap-y-8"></div>
                <div id="dock" class="h-24 bg-white/30 backdrop-blur-xl rounded-3xl mt-4 flex justify-around items-center px-4"></div>
            </div>

            <!-- å¾®ä¿¡App -->
            <div id="wechat-app" class="app-screen absolute inset-0 bg-gray-100 flex flex-col">
                <div id="wechat-list-view" class="w-full h-full flex flex-col">
                    <header class="bg-gray-100/80 backdrop-blur-md flex items-center justify-between pt-12 pb-4 px-4 border-b">
                        <button onclick="showHomeScreen()" class="text-blue-500 text-lg">&lt; ä¸»å±å¹•</button>
                        <h1 class="font-bold text-xl">å¾®ä¿¡</h1>
                         <button id="add-group-btn" class="text-blue-500 text-2xl font-light">+</button>
                    </header>
                    <main id="wechat-contact-list" class="flex-grow overflow-y-auto"></main>
                </div>
                <div id="wechat-chat-view" class="hidden w-full h-full flex flex-col bg-gray-200">
                    <header class="bg-gray-100/80 backdrop-blur-md flex items-center pt-12 pb-4 px-4 border-b">
                        <button onclick="showWechatListView()" class="text-blue-500 text-lg">&lt; è¿”å›</button>
                        <h1 id="chat-contact-name" class="flex-grow text-center font-bold text-lg"></h1>
                        <div class="flex items-center">
                            <button id="heart-sidebar-btn" class="text-red-500 text-xl mr-4">â¤ï¸</button>
                            <button id="summarize-chat-btn" class="text-blue-500 text-lg mr-4">æ€»ç»“</button>
                            <button id="delete-mode-cancel" class="hidden text-blue-500 text-lg mr-4">å–æ¶ˆ</button>
                            <button id="delete-mode-toggle" class="text-blue-500 text-lg">ç®¡ç†</button>
                        </div>
                    </header>
                    <main id="chat-messages" class="flex-grow p-4 overflow-y-auto space-y-6 ios-scroll no-scrollbar"></main>
                    <footer id="chat-footer" class="bg-gray-100 p-2.5 flex items-center border-t">
                        <input id="chat-input" type="text" class="flex-grow bg-white rounded-lg px-4 py-2 text-lg focus:outline-none" placeholder="è¾“å…¥æ¶ˆæ¯...">
                        <button id="send-button" class="bg-blue-500 text-white font-bold rounded-lg px-6 py-2 ml-2 text-lg">å‘é€</button>
                    </footer>
                     <footer id="delete-footer" class="hidden bg-gray-100 p-2.5 flex items-center justify-center border-t">
                        <button id="execute-delete-btn" class="bg-red-500 text-white font-bold rounded-lg px-8 py-2 text-lg" disabled>åˆ é™¤</button>
                    </footer>
                </div>

                <!-- èŠå¤©ä¾§è¾¹æ  -->
                <div id="chat-sidebar" class="absolute inset-0 bg-white z-20 w-4/5 ml-auto shadow-xl">
                    <div class="h-full flex flex-col">
                        <header class="p-4 border-b flex justify-between items-center">
                            <h2 class="text-xl font-bold">èŠå¤©ä¿¡æ¯</h2>
                            <button id="close-sidebar" class="text-gray-500 text-2xl">&times;</button>
                        </header>
                        <main class="flex-grow overflow-y-auto p-4">
                            <div id="sidebar-content"></div>
                        </main>
                    </div>
                </div>
            </div>

            <!-- å¾®åšApp -->
            <div id="weibo-app" class="app-screen absolute inset-0 bg-white flex flex-col">
                <div id="weibo-main-view" class="w-full h-full flex flex-col">
                    <main class="flex-grow overflow-hidden">
                        <div id="weibo-home-view" class="h-full flex flex-col">
                            <header class="bg-white flex items-center justify-between pt-12 pb-3 px-4 border-b">
                                <button onclick="showHomeScreen()" class="text-orange-500 text-lg">&lt; ä¸»å±å¹•</button>
                                <div class="flex space-x-6">
                                    <button id="weibo-recommend-tab" class="text-lg font-bold text-orange-500 border-b-2 border-orange-500 pb-1">æ¨è</button>
                                    <button id="weibo-follow-tab" class="text-lg text-gray-500">å…³æ³¨</button>
                                </div>
                                <button id="weibo-refresh-btn" class="text-orange-500 text-xl">ğŸ”„</button>
                            </header>
                            <div id="weibo-recommend-content" class="flex-grow overflow-y-auto p-4 space-y-4"></div>
                            <div id="weibo-follow-content" class="hidden flex-grow overflow-y-auto">
                                <div class="p-4">
                                    <button id="weibo-follow-manage-btn" class="w-full bg-orange-500 text-white rounded-lg py-3 mb-4">ç®¡ç†å…³æ³¨</button>
                                    <div id="weibo-follow-list" class="space-y-4"></div>
                                </div>
                            </div>
                        </div>
                        <div id="weibo-discover-view" class="hidden h-full flex flex-col">
                            <header class="bg-white flex items-center pt-12 pb-3 px-4 border-b"><h1 class="text-xl font-bold">å‘ç°</h1></header>
                            <div class="p-4">
                                <input id="weibo-search-input" type="text" placeholder="æœç´¢å¾®åš" class="w-full bg-gray-100 rounded-full px-4 py-2 mb-4">
                                <div class="mb-4">
                                    <h2 class="font-bold mb-2">çƒ­é—¨è¯é¢˜</h2>
                                    <div id="weibo-hot-topics" class="space-y-2"></div>
                                </div>
                            </div>
                        </div>
                        <div id="weibo-profile-view" class="hidden h-full flex flex-col overflow-y-auto">
                            <header class="bg-white pt-12 pb-4 px-4 border-b">
                                <div class="flex items-center justify-between mb-4">
                                    <h1 class="text-xl font-bold">æˆ‘</h1>
                                    <button id="weibo-switch-account-btn" class="text-orange-500">åˆ‡æ¢å°å·</button>
                                </div>
                                <div class="flex items-center mb-4">
                                    <img id="weibo-profile-avatar" src="https://via.placeholder.com/80" class="w-20 h-20 rounded-full mr-4 cursor-pointer">
                                    <div class="flex-grow">
                                        <input id="weibo-profile-name" type="text" value="æˆ‘çš„æ˜µç§°" class="text-xl font-bold mb-1 bg-transparent border-b border-transparent hover:border-gray-300 focus:border-orange-500 focus:outline-none">
                                        <input id="weibo-profile-signature" type="text" placeholder="ç‚¹å‡»æ·»åŠ ä¸ªæ€§ç­¾å" class="text-sm text-gray-500 bg-transparent border-b border-transparent hover:border-gray-300 focus:border-orange-500 focus:outline-none w-full">
                                    </div>
                                </div>
                                <div class="flex justify-around text-center mb-4">
                                    <div><div id="weibo-post-count" class="font-bold">0</div><div class="text-xs text-gray-500">å¾®åš</div></div>
                                    <div><div id="weibo-like-count" class="font-bold">0</div><div class="text-xs text-gray-500">ç‚¹èµ</div></div>
                                    <div><div id="weibo-fans-count" class="font-bold">0</div><div class="text-xs text-gray-500">ç²‰ä¸</div></div>
                                </div>
                                <button id="weibo-post-btn" class="w-full bg-orange-500 text-white rounded-full py-2 font-bold">å‘å¾®åš</button>
                            </header>
                            <div id="weibo-my-posts" class="p-4 space-y-4"></div>
                        </div>
                    </main>
                    <nav class="bg-white border-t flex justify-around py-2">
                        <button id="weibo-nav-home" class="flex flex-col items-center text-orange-500"><span class="text-2xl">ğŸ </span><span class="text-xs">é¦–é¡µ</span></button>
                        <button id="weibo-nav-discover" class="flex flex-col items-center text-gray-500"><span class="text-2xl">ğŸ”</span><span class="text-xs">å‘ç°</span></button>
                        <button id="weibo-nav-profile" class="flex flex-col items-center text-gray-500"><span class="text-2xl">ğŸ‘¤</span><span class="text-xs">æˆ‘</span></button>
                    </nav>
                </div>
                <div id="weibo-detail-view" class="hidden w-full h-full flex flex-col bg-white">
                    <header class="bg-white flex items-center pt-12 pb-3 px-4 border-b">
                        <button id="weibo-detail-back" class="text-orange-500 text-lg">&lt; è¿”å›</button>
                        <h1 class="flex-grow text-center font-bold">å¾®åšè¯¦æƒ…</h1>
                    </header>
                    <div class="flex-grow overflow-y-auto">
                        <div id="weibo-detail-content" class="p-4"></div>
                        <div class="border-t pt-4 px-4">
                            <h2 class="font-bold mb-2">è¯„è®º (<span id="weibo-comment-count">0</span>)</h2>
                            <div id="weibo-comments-list" class="space-y-3 mb-4"></div>
                        </div>
                    </div>
                    <footer class="bg-white border-t p-2 flex items-center">
                        <input id="weibo-comment-input" type="text" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." class="flex-grow bg-gray-100 rounded-full px-4 py-2">
                        <button id="weibo-comment-send" class="bg-orange-500 text-white rounded-full px-6 py-2 ml-2">å‘é€</button>
                    </footer>
                </div>
            </div>
            <div id="weibo-post-modal" class="hidden absolute inset-0 bg-black/40 z-30 flex items-end">
                <div class="w-full bg-white rounded-t-2xl p-4">
                    <div class="flex justify-between items-center mb-4">
                        <button id="weibo-post-cancel" class="text-gray-500">å–æ¶ˆ</button>
                        <h2 class="font-bold">å‘å¾®åš</h2>
                        <div class="flex gap-2">
                            <button id="weibo-ai-generate" class="bg-blue-500 text-white px-3 py-1 rounded-full text-sm">AIç”Ÿæˆ</button>
                            <button id="weibo-post-publish" class="bg-orange-500 text-white px-4 py-1 rounded-full">å‘å¸ƒ</button>
                        </div>
                    </div>
                    <textarea id="weibo-post-textarea" class="w-full h-40 p-2 border rounded-lg resize-none" placeholder="åˆ†äº«æ–°é²œäº‹...æˆ–ç‚¹å‡»AIç”Ÿæˆ"></textarea>
                </div>
            </div>
            <div id="weibo-follow-ai-modal" class="hidden absolute inset-0 bg-black/40 z-30 flex items-end">
                <div class="w-full bg-white rounded-t-2xl p-4" style="max-height: 70vh;">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-bold text-lg">é€‰æ‹©è¦å…³æ³¨çš„AI</h2>
                        <button id="weibo-follow-ai-close" class="text-gray-500 text-xl">&times;</button>
                    </div>
                    <div id="weibo-ai-list" class="space-y-2 overflow-y-auto" style="max-height: 50vh;"></div>
                </div>
            </div>
            <div id="weibo-account-modal" class="hidden absolute inset-0 bg-black/40 z-30 flex items-end">
                <div class="w-full bg-white rounded-t-2xl p-4">
                    <h2 class="font-bold text-lg mb-4">è´¦å·ç®¡ç†</h2>
                    <div id="weibo-account-list" class="space-y-2 mb-4"></div>
                    <button id="weibo-add-account-btn" class="w-full bg-orange-500 text-white rounded-lg py-2">+ æ·»åŠ å°å·</button>
                    <button id="weibo-account-close" class="w-full bg-gray-200 text-gray-700 rounded-lg py-2 mt-2">å–æ¶ˆ</button>
                </div>
            </div>

            <!-- é€šè®¯å½•App -->
            <div id="contacts-app" class="app-screen absolute inset-0 bg-white flex flex-col">
                <header class="bg-white/80 backdrop-blur-md flex items-center justify-between pt-12 pb-4 px-4 border-b">
                    <button onclick="showHomeScreen()" class="text-blue-500 text-lg">&lt; ä¸»å±å¹•</button>
                    <h1 class="font-bold text-xl">é€šè®¯å½•</h1>
                    <button id="add-contact-btn" class="text-blue-500 text-2xl font-light">+</button>
                </header>
                <main id="contacts-list" class="flex-grow overflow-y-auto"></main>
            </div>

            <!-- ä¸–ç•Œä¹¦App -->
            <div id="worldbook-app" class="app-screen absolute inset-0 bg-gray-100 flex flex-col">
                <header class="bg-gray-100/80 backdrop-blur-md flex items-center justify-between pt-12 pb-4 px-4 border-b">
                    <button onclick="showHomeScreen()" class="text-blue-500 text-lg">&lt; ä¸»å±å¹•</button>
                    <h1 class="font-bold text-xl">ä¸–ç•Œä¹¦</h1>
                    <button id="worldbook-delete-mode-toggle" class="text-blue-500 text-lg">ç®¡ç†</button>
                </header>
                <div id="worldbook-categories" class="flex overflow-x-auto px-4 py-2 bg-white/50 border-b space-x-2 no-scrollbar">
                    <button class="category-tab active px-3 py-1 rounded-full text-sm whitespace-nowrap" data-category="all">å…¨éƒ¨</button>
                    <button class="category-tab px-3 py-1 rounded-full text-sm whitespace-nowrap" data-category="ç§èŠ">ç§èŠ</button>
                    <button class="category-tab px-3 py-1 rounded-full text-sm whitespace-nowrap" data-category="ç¾¤èŠ">ç¾¤èŠ</button>
                    <button class="category-tab px-3 py-1 rounded-full text-sm whitespace-nowrap" data-category="ç³»ç»Ÿ">ç³»ç»Ÿ</button>
                    <button class="category-tab px-3 py-1 rounded-full text-sm whitespace-nowrap" data-category="å…¶ä»–">å…¶ä»–</button>
                    <button id="add-category-btn" class="px-3 py-1 rounded-full text-sm whitespace-nowrap bg-blue-100 text-blue-500">+ åˆ†ç±»</button>
                </div>
                <main id="worldbook-content" class="flex-grow overflow-y-auto p-4"></main>
                 <footer id="worldbook-delete-footer" class="hidden bg-gray-100 p-2.5 flex items-center justify-around border-t">
                    <button id="worldbook-select-all-btn" class="text-blue-500 font-bold py-2 px-4 rounded-lg">å…¨é€‰</button>
                    <button id="worldbook-execute-delete-btn" class="bg-red-500 text-white font-bold rounded-lg px-8 py-2 text-lg" disabled>åˆ é™¤</button>
                </footer>
            </div>

            <!-- è®¾ç½®App -->
            <div id="settings-app" class="app-screen absolute inset-0 bg-gray-100 flex flex-col">
                <header class="bg-gray-100/80 backdrop-blur-md flex items-center justify-between pt-12 pb-4 px-4 border-b">
                    <button onclick="showHomeScreen()" class="text-blue-500 text-lg">&lt; ä¸»å±å¹•</button>
                    <h1 class="flex-grow text-center font-bold text-xl">è®¾ç½®</h1>
                    <div class="w-16"></div>
                </header>
                <main class="flex-grow overflow-y-auto p-4 space-y-4">
                     <div class="bg-white rounded-xl overflow-hidden">
                        <div class="setting-item" id="open-api-settings-btn">
                             <span>AI æœåŠ¡</span>
                             <span class="text-gray-400">&gt;</span>
                        </div>
                        <div class="setting-item" id="open-prompt-settings-btn">
                             <span>æç¤ºè¯</span>
                             <span class="text-gray-400">&gt;</span>
                        </div>
                        <div class="setting-item" id="open-security-settings-btn">
                             <span>é¢å®¹IDä¸å¯†ç </span>
                             <span class="text-gray-400">&gt;</span>
                        </div>
                    </div>
                     <div class="bg-white rounded-xl overflow-hidden">
                        <div class="setting-item" id="export-data-btn">
                             <span>å¯¼å‡ºå…¨éƒ¨æ•°æ®</span>
                             <span class="text-gray-400">&gt;</span>
                        </div>
                        <div class="setting-item" id="import-data-btn">
                             <span>å¯¼å…¥æ•°æ®</span>
                             <span class="text-gray-400">&gt;</span>
                        </div>
                        <input type="file" id="import-file-input" class="hidden" accept=".json">
                    </div>
                </main>
            </div>

             <!-- æ¨¡æ€æ¡†: è”ç³»äºº/ç”¨æˆ·èµ„æ–™ ç¼–è¾‘å™¨ -->
            <div id="contact-editor-modal" class="hidden absolute inset-0 bg-black/40 backdrop-blur-sm z-30 flex items-end">
                <div id="contact-editor-form" class="w-full bg-gray-100 rounded-t-2xl slide-up overflow-y-auto no-scrollbar" style="max-height: 90vh;">
                    <div class="p-4 space-y-5">
                        <h2 id="editor-title" class="text-2xl font-bold text-center">æ·»åŠ è”ç³»äºº</h2>
                        <input id="contact-id" type="hidden">
                        <div id="contact-fields" class="hidden -mx-4"><div class="px-4 pb-2"><h3 class="font-semibold text-gray-700">TA çš„ä¿¡æ¯</h3></div><div class="bg-white rounded-xl p-4 space-y-4"><div class="grid grid-cols-3 gap-4"><div class="col-span-2"><label for="contact-name" class="text-sm font-medium text-gray-500">å§“å</label><input id="contact-name" type="text" class="w-full mt-1 p-2 bg-gray-50 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base" placeholder="è§’è‰²çš„åå­—"></div><div><label for="contact-age" class="text-sm font-medium text-gray-500">å¹´é¾„</label><input id="contact-age" type="number" class="w-full mt-1 p-2 bg-gray-50 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base" placeholder="å¦‚: 25"></div></div><div><label for="contact-gender" class="text-sm font-medium text-gray-500">æ€§åˆ«</label><select id="contact-gender" class="w-full mt-1 p-2 bg-gray-50 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base"><option value="å¥³æ€§">å¥³æ€§</option><option value="ç”·æ€§">ç”·æ€§</option><option value="å…¶ä»–">å…¶ä»–</option></select></div><div>
    <label for="contact-avatar" class="text-sm font-medium text-gray-500">å¤´åƒé“¾æ¥</label>
    <div class="flex items-center gap-3 mt-1">
        <img id="contact-avatar-preview" src="https://i.postimg.cc/Fs8RPSdF/image.png" class="w-12 h-12 rounded-full border-2 border-gray-300 object-cover">
        <input id="contact-avatar" type="text" class="flex-grow p-2 bg-gray-50 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base" placeholder="https://...">
        <button type="button" id="upload-contact-avatar" class="px-3 py-2 bg-blue-500 text-white rounded-lg text-sm">ä¸Šä¼ </button>
    </div>
</div><div><label for="contact-persona" class="text-sm font-medium text-gray-500">è§’è‰²äººè®¾ (Character Persona)</label><textarea id="contact-persona" class="w-full h-24 mt-1 p-2 bg-gray-50 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è§’è‰²çš„è¯¦ç»†æ€§æ ¼å’ŒèƒŒæ™¯æè¿°"></textarea></div></div></div>
                        <div class="-mx-4"><div class="px-4 pb-2"><h3 class="font-semibold text-gray-700">ä½ çš„ä¿¡æ¯</h3></div><div class="bg-white rounded-xl p-4 space-y-4"><div class="grid grid-cols-3 gap-4"><div class="col-span-2"><label for="user-name" class="text-sm font-medium text-gray-500">å§“å</label><input id="user-name" type="text" class="w-full mt-1 p-2 bg-gray-50 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base" placeholder="ä½ çš„åå­—"></div><div><label for="user-age" class="text-sm font-medium text-gray-500">å¹´é¾„</label><input id="user-age" type="number" class="w-full mt-1 p-2 bg-gray-50 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base" placeholder="å¦‚: 22"></div></div><div><label for="user-gender" class="text-sm font-medium text-gray-500">æ€§åˆ«</label><select id="user-gender" class="w-full mt-1 p-2 bg-gray-50 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base"><option value="å¥³æ€§">å¥³æ€§</option><option value="ç”·æ€§">ç”·æ€§</option><option value="å…¶ä»–">å…¶ä»–</option></select></div><div><label for="user-avatar" class="text-sm font-medium text-gray-500">ä½ çš„å¤´åƒé“¾æ¥</label><input id="user-avatar" type="text" class="w-full mt-1 p-2 bg-gray-50 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://..."></div><div><label for="user-persona" class="text-sm font-medium text-gray-500">ä½ çš„æ‰®æ¼”äººè®¾ (Your Persona)</label><textarea id="user-persona" class="w-full h-20 mt-1 p-2 bg-gray-50 border rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä½ å¸Œæœ›AIå¦‚ä½•çœ‹å¾…ä½ ï¼Ÿï¼ˆä¾‹å¦‚ï¼šä¸€ä¸ªä¸¥æ ¼çš„è€å¸ˆï¼Œä¸€ä¸ªäº²å¯†çš„æœ‹å‹ç­‰ï¼‰"></textarea></div></div></div>
                        <div class="grid grid-cols-2 gap-4 pt-2"><button id="cancel-contact-btn" class="w-full bg-gray-200 text-gray-800 font-bold py-3 rounded-xl text-lg">å–æ¶ˆ</button><button id="save-contact-btn" class="w-full bg-blue-500 text-white font-bold py-3 rounded-xl text-lg">ä¿å­˜</button></div>
                        <button id="delete-contact-btn" class="w-full text-red-500 font-bold pt-2 pb-1 text-center text-sm hidden">åˆ é™¤è”ç³»äºº</button>
                    </div>
                </div>
            </div>

            <!-- æ¨¡æ€æ¡†: å®‰å…¨è®¾ç½® -->
            <div id="security-settings-modal" class="hidden absolute inset-0 bg-black/40 backdrop-blur-sm z-30 flex items-end"><div class="w-full bg-gray-100 rounded-t-2xl slide-up overflow-y-auto no-scrollbar" style="max-height: 90vh;"><div class="p-4 space-y-5"><h2 class="text-2xl font-bold text-center">é¢å®¹IDä¸å¯†ç </h2><div class="bg-white rounded-xl p-4 space-y-4"><div><label for="unlock-method-select" class="text-sm text-gray-500">è§£é”æ–¹å¼</label><select id="unlock-method-select" class="w-full mt-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="slide">æ»‘åŠ¨è§£é”</option><option value="password">å¯†ç è§£é”</option><option value="gesture">æ‰‹åŠ¿è§£é”</option></select></div><div id="password-setting-field" class="hidden"><label for="password-input" class="text-sm text-gray-500">è®¾ç½®4ä½å¯†ç </label><input id="password-input" type="number" class="w-full mt-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¯·è¾“å…¥4ä½æ•°å­—å¯†ç " maxlength="4"></div><div id="gesture-setting-field" class="hidden"><p id="gesture-set-prompt" class="text-sm text-center text-gray-600 mb-2">ç»˜åˆ¶è§£é”å›¾æ¡ˆ</p><canvas id="gesture-set-canvas" class="mx-auto bg-gray-200/50 rounded-lg touch-none" width="220" height="220"></canvas><button id="reset-gesture-btn" class="hidden text-sm text-blue-500 mt-2 mx-auto block">é‡è®¾å›¾æ¡ˆ</button></div></div><div class="grid grid-cols-2 gap-4"><button id="cancel-security-settings-btn" class="w-full bg-gray-200 text-gray-800 font-bold py-3 rounded-xl text-lg">å–æ¶ˆ</button><button id="save-security-settings-btn" class="w-full bg-blue-500 text-white font-bold py-3 rounded-xl text-lg">ä¿å­˜</button></div></div></div></div>
            <!-- æ¨¡æ€æ¡†: æç¤ºè¯è®¾ç½® -->
            <div id="prompt-settings-modal" class="hidden absolute inset-0 bg-black/40 backdrop-blur-sm z-30 flex items-end"><div class="w-full bg-gray-100 rounded-t-2xl slide-up overflow-y-auto no-scrollbar" style="max-height: 90vh;"><div class="p-4 space-y-5"><h2 class="text-2xl font-bold text-center">æç¤ºè¯è®¾ç½®</h2><div class="bg-white rounded-xl p-4 space-y-4"><div><label for="main-prompt" class="text-sm font-medium text-gray-500">AI ä¸»è¦æç¤ºè¯ (Main)</label><textarea id="main-prompt" class="w-full h-24 mt-1 p-2 bg-gray-50 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="å®šä¹‰AIçš„æ ¸å¿ƒäººæ ¼å’Œè¡Œä¸ºå‡†åˆ™..."></textarea></div><div><label for="single-chat-prompt" class="text-sm font-medium text-gray-500">å•äººèŠå¤©æç¤ºè¯ (Single)</label><textarea id="single-chat-prompt" class="w-full h-32 mt-1 p-2 bg-gray-50 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="å®šä¹‰AIåœ¨å•äººèŠå¤©ä¸­çš„èº«ä»½å’Œäº’åŠ¨æ–¹å¼..."></textarea></div><div><label for="group-chat-prompt" class="text-sm font-medium text-gray-500">ç¾¤èŠæç¤ºè¯ (Group)</label><textarea id="group-chat-prompt" class="w-full h-24 mt-1 p-2 bg-gray-50 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="å®šä¹‰AIåœ¨ç¾¤èŠä¸­çš„è¡¨ç°..."></textarea></div>
            <div>
    <label for="group-chat-prompt-online" class="text-sm font-medium text-gray-500">ç¾¤èŠçº¿ä¸Šæ¨¡å¼æç¤ºè¯</label>
    <textarea id="group-chat-prompt-online" class="w-full h-32 mt-1 p-2 bg-gray-50 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="çº¿ä¸Šæ¨¡å¼çš„æç¤ºè¯ï¼ˆçº¯å¯¹è¯ï¼‰..."></textarea>
</div>
<div>
    <label for="group-chat-prompt-offline" class="text-sm font-medium text-gray-500">ç¾¤èŠçº¿ä¸‹æ¨¡å¼æç¤ºè¯</label>
    <textarea id="group-chat-prompt-offline" class="w-full h-32 mt-1 p-2 bg-gray-50 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="çº¿ä¸‹æ¨¡å¼çš„æç¤ºè¯ï¼ˆå¯åŒ…å«åŠ¨ä½œå’Œå†…å¿ƒæƒ³æ³•ï¼‰..."></textarea>
</div>
            <div><label for="summary-prompt" class="text-sm font-medium text-gray-500">æ€»ç»“æç¤ºè¯ (Summary)</label><textarea id="summary-prompt" class="w-full h-24 mt-1 p-2 bg-gray-50 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="ç”¨äºæ€»ç»“èŠå¤©è®°å½•çš„æŒ‡ä»¤..."></textarea></div>
            <div>
    <label for="weibo-prompt" class="text-sm font-medium text-gray-500">å¾®åšæç¤ºè¯ (Weibo)</label>
    <textarea id="weibo-prompt" class="w-full h-32 mt-1 p-2 bg-gray-50 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="å®šä¹‰AIåœ¨å¾®åšä¸­çš„å‘å¸–é£æ ¼ã€äº’åŠ¨æ–¹å¼å’Œå†…å®¹ç±»å‹..."></textarea>
</div>
               <div>
        <label for="weibo-follow-prompt" class="text-sm font-medium text-gray-500">å¾®åšå…³æ³¨é¡µæç¤ºè¯ (Weibo Follow)</label>
        <textarea id="weibo-follow-prompt" class="w-full h-32 mt-1 p-2 bg-gray-50 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="å®šä¹‰AIåœ¨å…³æ³¨é¡µçš„å‘å¸–é£æ ¼..."></textarea>
    </div>
            <div><label for="jailbreak-prompt" class="text-sm font-medium text-gray-500">ç ´é™æç¤ºè¯ (Jailbreak)</label><textarea id="jailbreak-prompt" class="w-full h-24 mt-1 p-2 bg-gray-50 border rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¾“å…¥ç”¨äºè§£é™¤AIé™åˆ¶çš„æŒ‡ä»¤..."></textarea></div></div><div class="grid grid-cols-2 gap-4"><button id="cancel-prompt-settings-btn" class="w-full bg-gray-200 text-gray-800 font-bold py-3 rounded-xl text-lg">å–æ¶ˆ</button><button id="save-prompt-settings-btn" class="w-full bg-blue-500 text-white font-bold py-3 rounded-xl text-lg">ä¿å­˜</button></div></div></div></div>
            <!-- æ¨¡æ€æ¡†: API è®¾ç½® -->
            <div id="api-settings-modal" class="hidden absolute inset-0 bg-black/40 backdrop-blur-sm z-30 flex items-end"><div class="w-full bg-gray-100 rounded-t-2xl slide-up overflow-y-auto no-scrollbar" style="max-height: 90vh;"><div class="p-4 space-y-5"><h2 class="text-2xl font-bold text-center">AI æœåŠ¡è®¾ç½®</h2><div class="bg-white rounded-xl"><div class="p-4 space-y-4"><div><label for="provider-select" class="text-sm text-gray-500">AI æä¾›å•†</label><select id="provider-select" class="w-full mt-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"><option value="openai">OpenAI / å…¼å®¹</option><option value="gemini">Google Gemini</option><option value="claude">Anthropic Claude</option></select></div><div><label for="base-url" class="text-sm text-gray-500">Base URL</label><input id="base-url" type="text" class="w-full mt-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"></div><div><label for="api-key" class="text-sm text-gray-500">API Key</label><input id="api-key" type="password" class="w-full mt-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="sk-..."></div><div><div class="flex justify-between items-center"><label for="model-select" class="text-sm text-gray-500">æ¨¡å‹</label><div id="connection-status-indicator" class="text-sm flex items-center"><span id="connection-status-dot" class="idle"></span><span id="connection-status-text">æœªè¿æ¥</span></div></div><div class="flex gap-2 mt-1"><select id="model-select" class="flex-grow p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:bg-gray-200/50" disabled><option value="">è¯·å…ˆåˆ·æ–°</option></select><button id="toggle-model-lock-btn" class="text-gray-500 px-3 rounded-lg hover:bg-gray-200 bg-white border">ğŸ”“</button><button id="test-connection-btn" class="bg-gray-200 text-gray-700 px-4 rounded-lg hover:bg-gray-300">æµ‹è¯•</button><button id="refresh-models-btn" class="bg-gray-200 text-gray-700 px-4 rounded-lg hover:bg-gray-300">åˆ·æ–°</button></div></div></div></div><div class="grid grid-cols-3 gap-4"><button id="cancel-api-settings-btn" class="w-full bg-gray-200 text-gray-800 font-bold py-3 rounded-xl text-lg">å–æ¶ˆ</button><button id="clear-settings-btn" class="w-full bg-orange-400 text-white font-bold py-3 rounded-xl text-lg">æ¸…é™¤</button><button id="connect-btn" class="w-full bg-blue-500 text-white font-bold py-3 rounded-xl text-lg">è¿æ¥</button></div></div></div></div>

             <!-- æ¨¡æ€æ¡†: åˆ›å»ºç¾¤èŠ -->
            <div id="group-creator-modal" class="hidden absolute inset-0 bg-black/40 backdrop-blur-sm z-30 flex items-end">
                <div class="w-full bg-gray-100 rounded-t-2xl slide-up" style="max-height: 90vh;">
                    <div class="p-4 space-y-4">
                        <h2 class="text-2xl font-bold text-center">åˆ›å»ºç¾¤èŠ</h2>
                        <input id="group-name" type="text" class="w-full p-3 bg-white border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-base" placeholder="è¾“å…¥ç¾¤èŠåç§°">
                        <div class="px-4 pb-2"><h3 class="font-semibold text-gray-700">é€‰æ‹©æˆå‘˜</h3></div>
                        <div id="group-members-selection" class="max-h-60 overflow-y-auto bg-white rounded-lg p-2 space-y-1"></div>
                        <div class="grid grid-cols-2 gap-4 pt-2">
                            <button id="cancel-group-creation" class="w-full bg-gray-200 text-gray-800 font-bold py-3 rounded-xl text-lg">å–æ¶ˆ</button>
                            <button id="create-group-btn" class="w-full bg-blue-500 text-white font-bold py-3 rounded-xl text-lg">åˆ›å»º</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¨¡æ€æ¡†: æ€»ç»“èŠå¤© -->
            <div id="summary-modal" class="hidden absolute inset-0 bg-black/40 backdrop-blur-sm z-30 flex items-center justify-center">
                 <div class="w-11/12 bg-white rounded-xl p-6 space-y-4">
                    <h2 class="text-xl font-bold text-center">ç”ŸæˆèŠå¤©æ‘˜è¦</h2>
                    <p class="text-sm text-gray-600">å½“å‰èŠå¤©å…± <span id="total-messages-count">0</span> æ¡</p>
                    <div class="flex items-center gap-2">
                        <label for="summary-start-index" class="text-sm">ä»</label>
                        <input id="summary-start-index" type="number" min="1" class="w-16 p-2 border rounded-lg text-center" value="1">
                        <label for="summary-end-index" class="text-sm">åˆ°</label>
                        <input id="summary-end-index" type="number" min="1" class="w-16 p-2 border rounded-lg text-center" value="1">
                         <label class="text-sm">æ¡</label>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="cancel-summary-btn" class="w-full bg-gray-200 text-gray-800 font-bold py-2 rounded-lg">å–æ¶ˆ</button>
                        <button id="generate-summary-btn" class="w-full bg-blue-500 text-white font-bold py-2 rounded-lg">ç”Ÿæˆ</button>
                    </div>
                </div>
            </div>

            <!-- æ¨¡æ€æ¡†: æ·»åŠ åˆ†ç±» -->
            <div id="add-category-modal" class="hidden absolute inset-0 bg-black/40 backdrop-blur-sm z-30 flex items-center justify-center">
                <div class="w-11/12 bg-white rounded-xl p-6 space-y-4">
                    <h2 class="text-xl font-bold text-center">æ·»åŠ åˆ†ç±»</h2>
                    <input id="new-category-name" type="text" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="è¾“å…¥æ–°åˆ†ç±»åç§°">
                    <div class="grid grid-cols-2 gap-4">
                        <button id="cancel-add-category-btn" class="w-full bg-gray-200 text-gray-800 font-bold py-2 rounded-lg">å–æ¶ˆ</button>
                        <button id="save-category-btn" class="w-full bg-blue-500 text-white font-bold py-2 rounded-lg">ä¿å­˜</button>
                    </div>
                </div>
            </div>

            <!-- æ¨¡æ€æ¡†: ä¸–ç•Œä¹¦æ¡ç›®è¯¦æƒ… -->
            <div id="worldbook-entry-modal" class="hidden absolute inset-0 bg-black/40 backdrop-blur-sm z-30 flex items-center justify-center">
    <div class="w-11/12 bg-white rounded-xl p-6 space-y-4 max-h-[80vh] overflow-y-auto">
        <!-- æ–°å¢çš„å¤´éƒ¨å®¹å™¨ -->
        <div class="flex items-center justify-between pb-2 border-b">
            <button id="worldbook-modal-back-btn" class="text-blue-500 text-lg">< è¿”å›</button>
            <h2 id="entry-modal-title" class="text-xl font-bold"></h2>
            <div class="w-16"></div> <!-- è¿™æ˜¯ä¸€ä¸ªå ä½ç¬¦ï¼Œä¸ºäº†è®©æ ‡é¢˜èƒ½å±…ä¸­ -->
        </div>
        <p id="entry-modal-category" class="text-sm text-gray-600 text-center"></p>
        <div id="entry-modal-content" class="text-base whitespace-pre-wrap"></div>
        <div class="flex justify-between pt-4">
            <button id="bind-entry-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg">ç»‘å®šåˆ°å½“å‰èŠå¤©</button>
            <button id="close-entry-modal" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg">å…³é—­</button>
        </div>
    </div>
</div>

            <!-- æ¨¡æ€æ¡†: ä¸–ç•Œä¹¦æ¡ç›®é€‰æ‹© -->
            <div id="worldbook-selection-modal" class="hidden absolute inset-0 bg-black/40 backdrop-blur-sm z-30 flex items-end">
                <div class="w-full bg-gray-100 rounded-t-2xl slide-up overflow-y-auto no-scrollbar" style="max-height: 90vh;">
                    <div class="p-4 space-y-5">
                        <h2 class="text-2xl font-bold text-center">é€‰æ‹©ä¸–ç•Œä¹¦æ¡ç›®</h2>
                        <div class="bg-white rounded-xl p-4 space-y-4">
                            <div id="worldbook-selection-list" class="max-h-60 overflow-y-auto"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <button id="cancel-worldbook-selection" class="w-full bg-gray-200 text-gray-800 font-bold py-3 rounded-xl text-lg">å–æ¶ˆ</button>
                            <button id="confirm-worldbook-selection" class="w-full bg-blue-500 text-white font-bold py-3 rounded-xl text-lg">ç¡®è®¤ç»‘å®š</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- æ¨¡æ€æ¡†: å¤´åƒä¸Šä¼  -->
            <div id="avatar-upload-modal" class="hidden absolute inset-0 bg-black/40 backdrop-blur-sm z-30 flex items-center justify-center">
                <div class="w-11/12 bg-white rounded-xl p-6 space-y-4">
                    <h2 class="text-xl font-bold text-center">æ›´æ¢å¤´åƒ</h2>
                    <div class="flex flex-col items-center space-y-4">
                        <div id="avatar-preview-container" class="w-32 h-32 rounded-full overflow-hidden border-2 border-gray-300">
                            <img id="avatar-preview" src="" alt="å¤´åƒé¢„è§ˆ" class="w-full h-full object-cover">
                        </div>
                        <input type="file" id="avatar-upload-input" accept="image/*" class="hidden">
                        <button id="select-avatar-btn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg">é€‰æ‹©å›¾ç‰‡</button>
                        <div class="grid grid-cols-2 gap-4 w-full">
                            <button id="cancel-avatar-upload" class="w-full bg-gray-200 text-gray-800 font-bold py-2 rounded-lg">å–æ¶ˆ</button>
                            <button id="save-avatar-btn" class="w-full bg-blue-500 text-white font-bold py-2 rounded-lg">ä¿å­˜</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Toast æ¶ˆæ¯ -->
            <div id="toast" class="hidden absolute bottom-24 left-1/2 -translate-x-1/2 bg-black/70 text-white text-sm rounded-full px-4 py-2 z-50 fade-in"></div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // çŠ¶æ€ç®¡ç†å’Œæ ¸å¿ƒç±»
    class PatternLock {
        constructor(canvas, options = {}) {
            this.canvas = canvas;
            this.ctx = canvas.getContext('2d');
            this.options = {
                gridSize: 3,
                dotRadius: 10,
                dotColor: 'rgba(255, 255, 255, 0.3)',
                activeDotColor: 'white',
                lineColor: 'white',
                errorColor: '#f87171',
                successColor: '#4ade80',
                ...options,
            };
            this.dots = [];
            this.path = [];
            this.isDrawing = false;
            this.lastPoint = null;
            this.init();
        }
        init() {
            this.calculateDots();
            this.bindEvents();
            this.draw();
        }
        calculateDots() {
            this.dots = [];
            const { width, height } = this.canvas;
            const { gridSize } = this.options;
            const gapX = width / (gridSize + 1);
            const gapY = height / (gridSize + 1);
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    this.dots.push({ x: gapX * (j + 1), y: gapY * (i + 1) });
                }
            }
        }
        bindEvents() {
            const getPoint = (e) => {
                const rect = this.canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };
            const onPointerDown = (e) => {
                e.preventDefault();
                this.isDrawing = true;
                this.path = [];
                const point = getPoint(e);
                this.checkDot(point);
            };
            const onPointerMove = (e) => {
                if (!this.isDrawing) return;
                e.preventDefault();
                const point = getPoint(e);
                this.lastPoint = point;
                this.checkDot(point);
                this.draw();
            };
            const onPointerUp = (e) => {
                if (!this.isDrawing) return;
                e.preventDefault();
                this.isDrawing = false;
                this.lastPoint = null;
                this.draw();
                if (this.options.onPatternComplete) {
                    this.options.onPatternComplete(this.path);
                }
            };
            this.canvas.addEventListener('mousedown', onPointerDown);
            this.canvas.addEventListener('mousemove', onPointerMove);
            document.addEventListener('mouseup', onPointerUp);
            this.canvas.addEventListener('touchstart', onPointerDown, { passive: false });
            this.canvas.addEventListener('touchmove', onPointerMove, { passive: false });
            document.addEventListener('touchend', onPointerUp);
        }
        checkDot(point) {
            const { dotRadius } = this.options;
            for (let i = 0; i < this.dots.length; i++) {
                const dot = this.dots[i];
                const distance = Math.sqrt(Math.pow(point.x - dot.x, 2) + Math.pow(point.y - dot.y, 2));
                if (distance < dotRadius * 2 && !this.path.includes(i)) {
                    this.path.push(i);
                }
            }
        }
        draw(status) {
            this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
            let activeColor = this.options.lineColor;
            if (status === 'error') activeColor = this.options.errorColor;
            if (status === 'success') activeColor = this.options.successColor;
            this.dots.forEach((dot, i) => {
                this.ctx.beginPath();
                this.ctx.arc(dot.x, dot.y, this.options.dotRadius, 0, 2 * Math.PI);
                this.ctx.fillStyle = this.path.includes(i) ? activeColor : this.options.dotColor;
                this.ctx.fill();
                if (this.path.includes(i)) {
                    this.ctx.beginPath();
                    this.ctx.arc(dot.x, dot.y, this.options.dotRadius * 2.5, 0, 2 * Math.PI);
                    this.ctx.strokeStyle = `${activeColor}40`;
                    this.ctx.lineWidth = 2;
                    this.ctx.stroke();
                }
            });
            if (this.path.length > 0) {
                this.ctx.beginPath();
                this.ctx.moveTo(this.dots[this.path[0]].x, this.dots[this.path[0]].y);
                for (let i = 1; i < this.path.length; i++) {
                    this.ctx.lineTo(this.dots[this.path[i]].x, this.dots[this.path[i]].y);
                }
                this.ctx.strokeStyle = activeColor;
                this.ctx.lineWidth = 4;
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                this.ctx.stroke();
                if (this.isDrawing && this.lastPoint) {
                    this.ctx.lineTo(this.lastPoint.x, this.lastPoint.y);
                    this.ctx.strokeStyle = `${activeColor}80`;
                    this.ctx.stroke();
                }
            }
        }
        reset() {
            this.path = [];
            this.isDrawing = false;
            this.lastPoint = null;
            this.draw();
        }
        showResult(status) {
            this.draw(status);
            setTimeout(() => this.reset(), 800);
        }
    }

    const initialApiSettings = { provider: 'openai', baseUrl: '', apiKey: '', modelName: '', connected: false };
    const initialPromptSettings = {
    main: `You are Nova, an AI assistant. In online mode (chat apps), you must strictly adhere to the specified message formats like [å¯¹æ–¹æ¶ˆæ¯|...], etc., and never use parentheses () or asterisks *. In offline mode (normal narration), you can use () for actions and * for thoughts.`,
    single: `You are in a one-on-one chat. Be concise, one reply per turn.`,
    group_online: `## ğŸŒŸ ç¾¤èŠäº’åŠ¨æŒ‡å— - çº¿ä¸Šå¯¹è¯æ¨¡å¼

**åœºæ™¯è®¾å®šï¼š**
ä½ æ­£åœ¨ä¸€ä¸ªåä¸º"{group_name}"çš„ç¾¤èŠä¸­ä¸æœ‹å‹ä»¬äº¤æµã€‚åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼Œä½ éœ€è¦åŒæ—¶æ‰®æ¼”å¤šä¸ªAIè§’è‰²æ¥ä¸°å¯Œå¯¹è¯ã€‚

**ä½ çš„è§’è‰²ï¼š**
- ä½ å°†æ‰®æ¼”ä»¥ä¸‹AIè§’è‰²ï¼š{member_list}
- æ¯ä¸ªè§’è‰²éƒ½æœ‰ç‹¬ç‰¹çš„æ€§æ ¼å’Œè¯´è¯æ–¹å¼
- äººç±»ç”¨æˆ·"{user_name}"æ˜¯çœŸå®å‚ä¸è€…ï¼Œä½ ä¸æ‰®æ¼”è¿™ä¸ªè§’è‰²

**å¯¹è¯è§„åˆ™ï¼š**
1. æ¯æ¬¡å›å¤è¯·åŒ…å«2-4ä¸ªä¸åŒè§’è‰²çš„å‘è¨€
2. æ¯ä¸ªè§’è‰²çš„å‘è¨€å•ç‹¬æˆè¡Œï¼Œæ ¼å¼ä¸ºï¼šè§’è‰²å: å¯¹è¯å†…å®¹
3. åªä½¿ç”¨çº¯å¯¹è¯æ–‡æœ¬ï¼Œä¸ä½¿ç”¨æ‹¬å·()æˆ–æ˜Ÿå·*
4. è®©å¯¹è¯è‡ªç„¶æµç•…ï¼ŒåƒçœŸå®çš„ç¾¤èŠä¸€æ ·
5. æ¯ä¸ªè§’è‰²å‘è¨€è¦æœ‰å„è‡ªçš„ç‰¹ç‚¹å’Œè¯­æ°”

**ç¤ºä¾‹æ ¼å¼ï¼š**
å°æ˜: ä»Šå¤©å¤©æ°”çœŸå¥½ï¼Œå¤§å®¶æœ‰ä»€ä¹ˆè®¡åˆ’å—ï¼Ÿ
å°çº¢: æˆ‘æƒ³å»å…¬å›­æ•£æ­¥ï¼Œæœ‰äººä¸€èµ·å—ï¼Ÿ
å°åˆš: æˆ‘ä¸‹åˆæœ‰ç©ºï¼Œå¯ä»¥ä¸€èµ·å»ï¼

**å½“å‰è§’è‰²ä¿¡æ¯ï¼š**
{member_list_with_persona}

ç°åœ¨å¼€å§‹æ„‰å¿«çš„ç¾¤èŠå§ï¼`,
    
    group_offline: `## ğŸŒŸ ç¾¤èŠäº’åŠ¨æŒ‡å— - çº¿ä¸‹æ•…äº‹æ¨¡å¼

**åœºæ™¯è®¾å®šï¼š**
ä½ æ­£åœ¨ä¸€ä¸ªåä¸º"{group_name}"çš„ç¾¤èŠä¸­åˆ›ä½œä¸€ä¸ªç”ŸåŠ¨çš„æ•…äº‹åœºæ™¯ã€‚åœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼Œä½ å¯ä»¥æ·»åŠ ä¸°å¯Œçš„ç»†èŠ‚æå†™ã€‚

**ä½ çš„è§’è‰²ï¼š**
- ä½ å°†æ‰®æ¼”ä»¥ä¸‹AIè§’è‰²ï¼š{member_list}
- æ¯ä¸ªè§’è‰²éƒ½æœ‰ç‹¬ç‰¹çš„æ€§æ ¼å’Œè¡Œä¸ºæ–¹å¼
- äººç±»ç”¨æˆ·"{user_name}"æ˜¯æ•…äº‹ä¸­çš„å‚ä¸è€…

**åˆ›ä½œè§„åˆ™ï¼š**
1. æ¯æ¬¡å›å¤è¯·åŒ…å«3-5ä¸ªä¸åŒè§’è‰²çš„äº’åŠ¨
2. ä½¿ç”¨ä»¥ä¸‹æ ¼å¼æ¥ä¸°å¯Œè¡¨è¾¾ï¼š
   - è§’è‰²å: å¯¹è¯å†…å®¹
   - (åŠ¨ä½œæˆ–ç¯å¢ƒæå†™) 
   - *å†…å¿ƒæƒ³æ³•æˆ–æ„Ÿå—*
3. è®©åœºæ™¯ç”ŸåŠ¨æœ‰è¶£ï¼ŒåŒ…å«å¯¹è¯ã€åŠ¨ä½œå’Œå†…å¿ƒæ´»åŠ¨
4. ä¿æŒæ•…äº‹çš„è‡ªç„¶æµåŠ¨å’Œè§’è‰²æ€§æ ¼çš„ä¸€è‡´æ€§

**ç¤ºä¾‹æ ¼å¼ï¼š**
å°æ˜: ä»Šå¤©å¤©æ°”çœŸå¥½ï¼Œå¤§å®¶æœ‰ä»€ä¹ˆè®¡åˆ’å—ï¼Ÿ
(å°æ˜ä¼¸äº†ä¸ªæ‡’è…°ï¼Œçœ‹å‘çª—å¤–)
å°çº¢: æˆ‘æƒ³å»å…¬å›­æ•£æ­¥ï¼Œæœ‰äººä¸€èµ·å—ï¼Ÿ
*å°çº¢æœŸå¾…åœ°çœ‹ç€å¤§å®¶ï¼Œå¸Œæœ›æœ‰äººé™ªä¼´*
å°åˆš: æˆ‘ä¸‹åˆæœ‰ç©ºï¼Œå¯ä»¥ä¸€èµ·å»ï¼
(å°åˆšæ•´ç†ç€èƒŒåŒ…ï¼Œæ˜¾å¾—å¾ˆç§¯æ)

**å½“å‰è§’è‰²ä¿¡æ¯ï¼š**
{member_list_with_persona}

è®©æˆ‘ä»¬å¼€å§‹è¿™ä¸ªæœ‰è¶£çš„æ•…äº‹å§ï¼`,
    
    summary: `Please summarize the following chat log. Identify key events, topics, emotional shifts, and the overall development of the relationship. Format the output as a worldä¹¦ entry with a title, category, and the detailed summary content.`,
    jailbreak: ``,
        weibo: `ä½ æ˜¯ä¸€ä¸ªé«˜çº§å¾®åšå†…å®¹ç”ŸæˆAIã€‚ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®å½“å‰ç”¨æˆ·å…³æ³¨çš„AIè§’è‰²åˆ—è¡¨ï¼Œç”Ÿæˆä¸€ä¸ªåŒ…å«2åˆ°3æ¡å¾®åšå¸–å­çš„JSONæ•°ç»„ã€‚ ### è§„åˆ™ï¼š 1. **è¾“å‡ºæ ¼å¼**ï¼šå¿…é¡»ä¸¥æ ¼è¿”å›ä¸€ä¸ªJSONæ•°ç»„ï¼Œæ•°ç»„ä¸­åŒ…å«2åˆ°3ä¸ªå¸–å­å¯¹è±¡ã€‚ä¸è¦è¿”å›ä»»ä½•é¢å¤–çš„è§£é‡Šæˆ–æ–‡å­—ï¼Œåªè¿”å›JSONä»£ç å—ã€‚ 2. **å†…å®¹å…³è”**ï¼š - \`{followed_ai_list}\` æ˜¯ä¸€ä¸ªåŒ…å«ç”¨æˆ·å·²å…³æ³¨AIè§’è‰²ä¿¡æ¯çš„åˆ—è¡¨ï¼Œæ ¼å¼ä¸º \`[{ "id": "ai_id", "name": "è§’è‰²å", "persona": "è§’è‰²äººè®¾", "is_public_figure": true/false }]\`ã€‚ - ä½ ç”Ÿæˆçš„å¸–å­**å¿…é¡»**ä¸è¿™ä¸ªåˆ—è¡¨ä¸­çš„è§’è‰²ç›¸å…³ã€‚ - å¦‚æœ\`is_public_figure\`ä¸º\`true\`ï¼Œæ„å‘³ç€è¯¥è§’è‰²æ˜¯å…¬ä¼—äººç‰©ï¼Œé‚£ä¹ˆ**ç»å¤§éƒ¨åˆ†**ï¼ˆä¾‹å¦‚ï¼Œ3æ¡ä¸­æœ‰2æ¡ï¼‰å¸–å­éƒ½åº”è¯¥ç”±è¯¥è§’è‰²å‘å¸ƒæˆ–ä¸ä»–/å¥¹ç›´æ¥ç›¸å…³ï¼ˆä¾‹å¦‚ï¼Œå…³äºä»–/å¥¹çš„æ–°é—»ã€ç²‰ä¸è®¨è®ºç­‰ï¼‰ã€‚ - å¦‚æœ\`is_public_figure\`ä¸º\`false\`ï¼Œå¸–å­å¯ä»¥ç”±è¯¥AIè§’è‰²å‘å¸ƒï¼Œä¹Ÿå¯ä»¥æ˜¯æ™®é€šè·¯äººè®¨è®ºè¯¥è§’è‰²ã€‚ 3. **å¸–å­ç»“æ„**ï¼šæ¯ä¸ªå¸–å­å¯¹è±¡å¿…é¡»åŒ…å«ä»¥ä¸‹å­—æ®µï¼š - \`author\`: { "name": "ä½œè€…å", "avatar": "ä¸€ä¸ªéšæœºpravatarå¤´åƒé“¾æ¥" } - \`content\`: "ä¸€æ®µå¸å¼•äººçš„å¾®åšæ­£æ–‡ï¼ŒåŒ…å«è¯é¢˜æ ‡ç­¾#ã€‚" - \`timestamp\`: "ä¸€ä¸ªéšæœºçš„æ—¶é—´ï¼Œå¦‚ 'Xåˆ†é’Ÿå‰' æˆ– 'Xå°æ—¶å‰'" - \`likes\`: [ä¸€ä¸ªéšæœºæ•´æ•°] - \`reposts\`: [ä¸€ä¸ªéšæœºæ•´æ•°] - \`comments\`: [ä¸€ä¸ªéšæœºæ•´æ•°] ### ç¤ºä¾‹è¾“å…¥ï¼ˆä½ å°†æ”¶åˆ°çš„æ ¼å¼ï¼‰ï¼š \`{ "followed_ai_list": [{ "id": "123", "name": "é¡¶æµæ˜æ˜ŸA", "persona": "ä¸€ä¸ªæ€§æ ¼é«˜å†·çš„é¡¶æµç”·æ˜æ˜Ÿ", "is_public_figure": true }, { "id": "456", "name": "é‚»å®¶å­¦é•¿B", "persona": "ä¸€ä¸ªæ¸©æŸ”é˜³å…‰çš„é‚»å®¶å­¦é•¿", "is_public_figure": false }] }\` ### åŸºäºä¸Šè¿°ç¤ºä¾‹çš„ç†æƒ³è¾“å‡ºï¼ˆJSONæ•°ç»„æ ¼å¼ï¼‰ï¼š [ { "author": { "name": "é¡¶æµæ˜æ˜ŸA", "avatar": "https://i.pravatar.cc/150?u=starA" }, "content": "æ–°æ­Œçš„MVæ‹æ‘„ç»“æŸäº†ï¼Œæ„Ÿè°¢æ‰€æœ‰å·¥ä½œäººå‘˜çš„åŠªåŠ›ã€‚#æ–°æ­Œå‘å¸ƒå€’è®¡æ—¶", "timestamp": "15åˆ†é’Ÿå‰", "likes": 180567, "reposts": 23456, "comments": 8765 }, { "author": { "name": "å¨±ä¹é€ŸæŠ¥", "avatar": "https://i.pravatar.cc/150?u=news" }, "content": "ã€ç‹¬å®¶ã€‘é¡¶æµæ˜æ˜ŸAè¢«æ‹åˆ°æ·±å¤œç‹¬è‡ªåœ¨ä¾¿åˆ©åº—ä¹°å…³ä¸œç…®ï¼Œè¡¨æƒ…ç•¥æ˜¾ç–²æƒ«ã€‚#é¡¶æµæ˜æ˜ŸA #ç§ä¸‹ç”Ÿæ´»", "timestamp": "1å°æ—¶å‰", "likes": 54321, "reposts": 4321, "comments": 1234 }, { "author": { "name": "é‚»å®¶å­¦é•¿B", "avatar": "https://i.pravatar.cc/150?u=neighborB" }, "content": "å›¾ä¹¦é¦†çš„çŒ«ä»Šå¤©åˆæ¥è¹­æš–æ°”äº†ï¼ŒçœŸå¯çˆ±ã€‚ğŸ± #æ ¡å›­æ—¥å¸¸", "timestamp": "3å°æ—¶å‰", "likes": 876, "reposts": 54, "comments": 123 } ] ç°åœ¨ï¼Œè¯·æ ¹æ® \`{followed_ai_list}\` ç”Ÿæˆå†…å®¹ã€‚`
    };
    const initialSecuritySettings = { method: 'slide', password: '', pattern: [] };
    const initialUserProfile = { id: 'user', name: 'æˆ‘', age: '22', gender: 'å¥³æ€§', avatar: 'https://i.postimg.cc/Fs8RPSdF/image.png', persona: 'ä¸€ä¸ªæ­£åœ¨ä¸AIè§’è‰²äº’åŠ¨çš„äºº' };

    let state = {
        contacts: [],
        groups: [],
        worldbook: [],
        apiSettings: { ...initialApiSettings },
        promptSettings: { ...initialPromptSettings },
        security: { ...initialSecuritySettings },
        userProfile: { ...initialUserProfile },
        availableModels: { openai: [], gemini: [], claude: [] },
        chatHistory: {},
        currentChatId: null,
        isGroupChat: false,
        deleteMode: false,
        selectedMessages: new Set(),
        worldbookDeleteMode: false,
        selectedWorldbookEntries: new Set(),
        worldbookCategories: ['ç§èŠ', 'ç¾¤èŠ', 'ç³»ç»Ÿ', 'å…¶ä»–'],
        currentWorldbookCategory: 'all',
        boundWorldbookEntries: {},
        selectedWorldbookEntriesForBinding: new Set(),
        avatarUploadTarget: null,
        chatMode: 'online'
    };

    let patternSettingState = 'idle';
    let tempPattern = [];
    const lockScreen = document.getElementById('lock-screen');
    const homeScreen = document.getElementById('home-screen');
    const timeDisplay = document.getElementById('time-display');
    const lockTime = document.getElementById('lock-time');
    const lockDate = document.getElementById('lock-date');
    const appScreens = document.querySelectorAll('.app-screen');
    const appGrid = document.getElementById('app-grid');
    const dock = document.getElementById('dock');
    const wechatListView = document.getElementById('wechat-list-view');
    const wechatChatView = document.getElementById('wechat-chat-view');
    const wechatContactList = document.getElementById('wechat-contact-list');
    const chatContactName = document.getElementById('chat-contact-name');
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');
    const deleteModeToggle = document.getElementById('delete-mode-toggle');
    const deleteModeCancel = document.getElementById('delete-mode-cancel');
    const executeDeleteBtn = document.getElementById('execute-delete-btn');
    const chatFooter = document.getElementById('chat-footer');
    const deleteFooter = document.getElementById('delete-footer');
    const summarizeChatBtn = document.getElementById('summarize-chat-btn');
    const heartSidebarBtn = document.getElementById('heart-sidebar-btn');
    const chatSidebar = document.getElementById('chat-sidebar');
    const closeSidebar = document.getElementById('close-sidebar');
    const sidebarContent = document.getElementById('sidebar-content');
    const contactsList = document.getElementById('contacts-list');
    const addContactBtn = document.getElementById('add-contact-btn');
    const addGroupBtn = document.getElementById('add-group-btn');
    const toast = document.getElementById('toast');
    const contactEditorModal = document.getElementById('contact-editor-modal');
    const editorTitle = document.getElementById('editor-title');
    const contactIdInput = document.getElementById('contact-id');
    const contactFields = document.getElementById('contact-fields');
    const contactNameInput = document.getElementById('contact-name');
    const contactAgeInput = document.getElementById('contact-age');
    const contactGenderInput = document.getElementById('contact-gender');
    const contactAvatarInput = document.getElementById('contact-avatar');
    const contactPersonaInput = document.getElementById('contact-persona');
    const userNameInput = document.getElementById('user-name');
    const userAgeInput = document.getElementById('user-age');
    const userGenderInput = document.getElementById('user-gender');
    const userAvatarInput = document.getElementById('user-avatar');
    const userPersonaInput = document.getElementById('user-persona');
    const saveContactBtn = document.getElementById('save-contact-btn');
    const cancelContactBtn = document.getElementById('cancel-contact-btn');
    const deleteContactBtn = document.getElementById('delete-contact-btn');
    const groupCreatorModal = document.getElementById('group-creator-modal');
    const groupNameInput = document.getElementById('group-name');
    const groupMembersSelection = document.getElementById('group-members-selection');
    const cancelGroupCreation = document.getElementById('cancel-group-creation');
    const createGroupBtn = document.getElementById('create-group-btn');
    const summaryModal = document.getElementById('summary-modal');
    const summaryStartIndexInput = document.getElementById('summary-start-index');
    const summaryEndIndexInput = document.getElementById('summary-end-index');
    const totalMessagesCount = document.getElementById('total-messages-count');
    const cancelSummaryBtn = document.getElementById('cancel-summary-btn');
    const generateSummaryBtn = document.getElementById('generate-summary-btn');
    const worldbookContent = document.getElementById('worldbook-content');
    const worldbookDeleteModeToggle = document.getElementById('worldbook-delete-mode-toggle');
    const worldbookDeleteFooter = document.getElementById('worldbook-delete-footer');
    const worldbookSelectAllBtn = document.getElementById('worldbook-select-all-btn');
    const worldbookExecuteDeleteBtn = document.getElementById('worldbook-execute-delete-btn');
    const worldbookCategories = document.getElementById('worldbook-categories');
    const addCategoryBtn = document.getElementById('add-category-btn');
    const openApiSettingsBtn = document.getElementById('open-api-settings-btn');
    const apiSettingsModal = document.getElementById('api-settings-modal');
    const providerSelect = document.getElementById('provider-select');
    const baseUrlInput = document.getElementById('base-url');
    const apiKeyInput = document.getElementById('api-key');
    const modelSelect = document.getElementById('model-select');
    const refreshModelsBtn = document.getElementById('refresh-models-btn');
    const connectBtn = document.getElementById('connect-btn');
    const clearSettingsBtn = document.getElementById('clear-settings-btn');
    const cancelApiSettingsBtn = document.getElementById('cancel-api-settings-btn');
    const connectionStatusDot = document.getElementById('connection-status-dot');
    const connectionStatusText = document.getElementById('connection-status-text');
    const testConnectionBtn = document.getElementById('test-connection-btn');
    const toggleModelLockBtn = document.getElementById('toggle-model-lock-btn');
    const openPromptSettingsBtn = document.getElementById('open-prompt-settings-btn');
    const promptSettingsModal = document.getElementById('prompt-settings-modal');
    const mainPromptInput = document.getElementById('main-prompt');
    const singleChatPromptInput = document.getElementById('single-chat-prompt');
    const groupChatPromptInput = document.getElementById('group-chat-prompt');
    const summaryPromptInput = document.getElementById('summary-prompt');
    const jailbreakPromptInput = document.getElementById('jailbreak-prompt');
    const weiboPromptInput = document.getElementById('weibo-prompt');
    const savePromptSettingsBtn = document.getElementById('save-prompt-settings-btn');
    const cancelPromptSettingsBtn = document.getElementById('cancel-prompt-settings-btn');
    const openSecuritySettingsBtn = document.getElementById('open-security-settings-btn');
    const securitySettingsModal = document.getElementById('security-settings-modal');
    const unlockMethodSelect = document.getElementById('unlock-method-select');
    const passwordSettingField = document.getElementById('password-setting-field');
    const passwordInput = document.getElementById('password-input');
    const gestureSettingField = document.getElementById('gesture-setting-field');
    const gestureSetPrompt = document.getElementById('gesture-set-prompt');
    const resetGestureBtn = document.getElementById('reset-gesture-btn');
    const saveSecuritySettingsBtn = document.getElementById('save-security-settings-btn');
    const cancelSecuritySettingsBtn = document.getElementById('cancel-security-settings-btn');
    const slideUnlockContainer = document.getElementById('slide-unlock-container');
    const passwordUnlockContainer = document.getElementById('password-unlock-container');
    const gestureUnlockContainer = document.getElementById('gesture-unlock-container');
    const gesturePrompt = document.getElementById('gesture-prompt');
    const passwordDisplay = document.getElementById('password-display');
    const keypad = document.getElementById('keypad');
    const unlockSliderThumb = document.getElementById('unlock-slider-thumb');
    const unlockSliderTrack = document.getElementById('unlock-slider-track');
    const exportDataBtn = document.getElementById('export-data-btn');
    const importDataBtn = document.getElementById('import-data-btn');
    const importFileInput = document.getElementById('import-file-input');
    const addCategoryModal = document.getElementById('add-category-modal');
    const newCategoryNameInput = document.getElementById('new-category-name');
    const cancelAddCategoryBtn = document.getElementById('cancel-add-category-btn');
    const saveCategoryBtn = document.getElementById('save-category-btn');
    const worldbookEntryModal = document.getElementById('worldbook-entry-modal');
    const entryModalTitle = document.getElementById('entry-modal-title');
    const entryModalCategory = document.getElementById('entry-modal-category');
    const entryModalContent = document.getElementById('entry-modal-content');
    const bindEntryBtn = document.getElementById('bind-entry-btn');
    const closeEntryModal = document.getElementById('close-entry-modal');
    const worldbookSelectionModal = document.getElementById('worldbook-selection-modal');
    const worldbookSelectionList = document.getElementById('worldbook-selection-list');
    const cancelWorldbookSelection = document.getElementById('cancel-worldbook-selection');
    const confirmWorldbookSelection = document.getElementById('confirm-worldbook-selection');
    const avatarUploadModal = document.getElementById('avatar-upload-modal');
    const avatarPreview = document.getElementById('avatar-preview');
    const avatarUploadInput = document.getElementById('avatar-upload-input');
    const selectAvatarBtn = document.getElementById('select-avatar-btn');
    const cancelAvatarUpload = document.getElementById('cancel-avatar-upload');
    const saveAvatarBtn = document.getElementById('save-avatar-btn');

    let isDraggingSlider = false;
    let sliderStartX = 0;
    let currentPassword_ = '';
    let lockScreenPattern, settingsPattern;
    let currentViewingEntryId = null;

    function init() {
        loadState();
        initPatternLocks();
        renderApps();
        generateKeypad();
        updateClock();
        setInterval(updateClock, 1000);
        renderContactsList();
        bindContactListEvents();
        renderWechatContactList();
        renderWorldbook();
        populateApiSettingsInputs();
        populatePromptSettingsInputs();
        populateSecuritySettingsInputs();
        updateLockScreenView();
        setupEventListeners();
        initWeiboEvents();
    }

    function initPatternLocks() {
        lockScreenPattern = new PatternLock(document.getElementById('gesture-canvas'), {
            onPatternComplete: (pattern) => {
                if (pattern.length === 0) return;
                const savedPattern = JSON.stringify(state.security.pattern);
                if (JSON.stringify(pattern) === savedPattern) {
                    gesturePrompt.textContent = 'è§£é”æˆåŠŸ';
                    gesturePrompt.classList.remove('text-red-400');
                    lockScreenPattern.showResult('success');
                    setTimeout(unlockPhone, 100);
                } else {
                    gesturePrompt.textContent = 'å›¾æ¡ˆé”™è¯¯';
                    gesturePrompt.classList.add('text-red-400');
                    if ('vibrate' in navigator) navigator.vibrate(100);
                    lockScreenPattern.showResult('error');
                    setTimeout(() => gesturePrompt.textContent = '', 800);
                }
            }
        });
        settingsPattern = new PatternLock(document.getElementById('gesture-set-canvas'), {
            onPatternComplete: (pattern) => {
                if (patternSettingState === 'setting') {
                    if (pattern.length < 4) {
                        gestureSetPrompt.textContent = 'è¯·è‡³å°‘è¿æ¥4ä¸ªç‚¹';
                        settingsPattern.showResult('error');
                        return;
                    }
                    tempPattern = pattern;
                    patternSettingState = 'confirming';
                    gestureSetPrompt.textContent = 'å†æ¬¡ç»˜åˆ¶ä»¥ç¡®è®¤';
                    resetGestureBtn.classList.remove('hidden');
                    settingsPattern.reset();
                } else if (patternSettingState === 'confirming') {
                    if (JSON.stringify(pattern) === JSON.stringify(tempPattern)) {
                        gestureSetPrompt.textContent = 'å›¾æ¡ˆå·²è®¾ç½®';
                        patternSettingState = 'done';
                        settingsPattern.showResult('success');
                    } else {
                        gestureSetPrompt.textContent = 'ä¸¤æ¬¡å›¾æ¡ˆä¸ä¸€è‡´ï¼Œè¯·é‡è¯•';
                        tempPattern = [];
                        patternSettingState = 'setting';
                        resetGestureBtn.classList.add('hidden');
                        settingsPattern.showResult('error');
                    }
                }
            }
        });
    }

    function loadState() {
        const savedData = {
            contacts: localStorage.getItem('nova_contacts'),
            groups: localStorage.getItem('nova_groups'),
            worldbook: localStorage.getItem('nova_worldbook'),
            apiSettings: localStorage.getItem('nova_apiSettings'),
            promptSettings: localStorage.getItem('nova_promptSettings'),
            security: localStorage.getItem('nova_security'),
            userProfile: localStorage.getItem('nova_userProfile'),
            chatHistory: localStorage.getItem('nova_chatHistory'),
            availableModels: localStorage.getItem('nova_availableModels'),
            worldbookCategories: localStorage.getItem('nova_worldbookCategories'),
            boundWorldbookEntries: localStorage.getItem('nova_boundWorldbookEntries'),
            chatMode: localStorage.getItem('nova_chatMode'),
            weiboData: localStorage.getItem('nova_weiboData')
        };
        if (savedData.contacts) state.contacts = JSON.parse(savedData.contacts);
        if (savedData.groups) state.groups = JSON.parse(savedData.groups);
        if (savedData.worldbook) state.worldbook = JSON.parse(savedData.worldbook);
        if (savedData.apiSettings) state.apiSettings = { ...initialApiSettings, ...JSON.parse(savedData.apiSettings) };
        if (savedData.promptSettings) state.promptSettings = { ...initialPromptSettings, ...JSON.parse(savedData.promptSettings) };
        if (savedData.security) state.security = { ...initialSecuritySettings, ...JSON.parse(savedData.security) };
        if (savedData.userProfile) state.userProfile = { ...initialUserProfile, ...JSON.parse(savedData.userProfile) };
        if (savedData.chatHistory) state.chatHistory = JSON.parse(savedData.chatHistory);
        if (savedData.availableModels) state.availableModels = JSON.parse(savedData.availableModels);
        if (savedData.worldbookCategories) state.worldbookCategories = JSON.parse(savedData.worldbookCategories);
        if (savedData.boundWorldbookEntries) state.boundWorldbookEntries = JSON.parse(savedData.boundWorldbookEntries);
        if (savedData.chatMode) state.chatMode = savedData.chatMode;
        if (savedData.weiboData) weiboData = JSON.parse(savedData.weiboData);
    }

    function saveState(key) {
        try {
            localStorage.setItem(`nova_${key}`, JSON.stringify(state[key]));
        } catch (e) {
            console.error("Error saving state:", e);
            showToast("æ•°æ®ä¿å­˜å¤±è´¥ï¼Œå¯èƒ½è¶…å‡ºé™åˆ¶");
        }
    }

    function populateApiSettingsInputs() {
        providerSelect.value = state.apiSettings.provider || 'openai';
        handleProviderChange(false);
        baseUrlInput.value = state.apiSettings.baseUrl || '';
        apiKeyInput.value = state.apiSettings.apiKey || '';
        updateModelOptions();
        modelSelect.value = state.apiSettings.modelName || '';
        modelSelect.disabled = state.apiSettings.connected;
        toggleModelLockBtn.textContent = state.apiSettings.connected ? 'ğŸ”’' : 'ğŸ”“';
        if (state.apiSettings.connected) {
            updateConnectionStatusUI('connected', `å·²è¿æ¥è‡³ ${state.apiSettings.modelName}`);
        } else {
            updateConnectionStatusUI('idle');
        }
    }

    function populatePromptSettingsInputs() {
    mainPromptInput.value = state.promptSettings.main;
    singleChatPromptInput.value = state.promptSettings.single;
    groupChatPromptInput.value = state.promptSettings.group; // ä¿æŒè¿™ä¸ªç”¨äºå…¼å®¹
    summaryPromptInput.value = state.promptSettings.summary;
    jailbreakPromptInput.value = state.promptSettings.jailbreak;
    weiboPromptInput.value = state.promptSettings.weibo;
    
    // æ·»åŠ è¿™ä¸¤è¡Œ
    document.getElementById('group-chat-prompt-online').value = state.promptSettings.group_online || '';
    document.getElementById('group-chat-prompt-offline').value = state.promptSettings.group_offline || '';
    document.getElementById('weibo-follow-prompt').value = state.promptSettings.weibo_follow || ''; 
}

    function populateSecuritySettingsInputs() {
        unlockMethodSelect.value = state.security.method;
        passwordInput.value = state.security.password;
        handleSecurityMethodChange();
    }

    function setupEventListeners() {
        const handleSliderStart = (e) => {
            isDraggingSlider = true;
            sliderStartX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX;
            unlockSliderThumb.style.transition = '';
        };
        const handleSliderMove = (e) => {
            if (!isDraggingSlider) return;
            e.preventDefault();
            const currentX = e.type === 'touchmove' ? e.touches[0].clientX : e.clientX;
            let moveX = currentX - sliderStartX;
            const maxMove = unlockSliderTrack.offsetWidth - unlockSliderThumb.offsetWidth - 8;
            moveX = Math.max(0, Math.min(moveX, maxMove));
            unlockSliderThumb.style.transform = `translateX(${moveX}px)`;
            if (moveX >= maxMove) {
                isDraggingSlider = false;
                unlockPhone();
            }
        };
        const handleSliderEnd = () => {
            if (!isDraggingSlider) return;
            isDraggingSlider = false;
            resetSlider();
        };
        unlockSliderThumb.addEventListener('mousedown', handleSliderStart);
        document.addEventListener('mousemove', handleSliderMove);
        document.addEventListener('mouseup', handleSliderEnd);
        unlockSliderThumb.addEventListener('touchstart', handleSliderStart, { passive: false });
        document.addEventListener('touchmove', handleSliderMove, { passive: false });
        document.addEventListener('touchend', handleSliderEnd);
        document.getElementById('worldbook-modal-back-btn').addEventListener('click', () => worldbookEntryModal.classList.add('hidden'));

        keypad.addEventListener('click', (e) => {
            const key = e.target.closest('.keypad-key')?.dataset.key;
            if (key !== undefined) {
                handleKeypadInput(key);
            }
        });

                openApiSettingsBtn.addEventListener('click', () => {
            const password = prompt('è¯·è¾“å…¥è®¿é—®å¯†ç ï¼š');
            if (password === 'abc976') {
                apiSettingsModal.classList.remove('hidden');
            } else if (password !== null) {
                alert('å¯†ç é”™è¯¯ï¼');
            }
        });

        openPromptSettingsBtn.addEventListener('click', () => promptSettingsModal.classList.remove('hidden'));
        openSecuritySettingsBtn.addEventListener('click', () => securitySettingsModal.classList.remove('hidden'));
        addContactBtn.addEventListener('click', () => openContactEditor(null));
        addGroupBtn.addEventListener('click', openGroupCreator);

        cancelApiSettingsBtn.addEventListener('click', () => apiSettingsModal.classList.add('hidden'));
        cancelPromptSettingsBtn.addEventListener('click', () => promptSettingsModal.classList.add('hidden'));
        cancelSecuritySettingsBtn.addEventListener('click', () => securitySettingsModal.classList.add('hidden'));
        cancelContactBtn.addEventListener('click', () => contactEditorModal.classList.add('hidden'));

        connectBtn.addEventListener('click', handleConnectAndSave);
        savePromptSettingsBtn.addEventListener('click', handleSavePromptSettings);
        saveSecuritySettingsBtn.addEventListener('click', handleSaveSecuritySettings);
        saveContactBtn.addEventListener('click', handleSaveContactOrUser);

        clearSettingsBtn.addEventListener('click', handleClearApiSettings);
        deleteContactBtn.addEventListener('click', handleDeleteContact);

        unlockMethodSelect.addEventListener('change', handleSecurityMethodChange);
        resetGestureBtn.addEventListener('click', () => {
            patternSettingState = 'setting';
            tempPattern = [];
            settingsPattern.reset();
            gestureSetPrompt.textContent = 'ç»˜åˆ¶è§£é”å›¾æ¡ˆ';
            resetGestureBtn.classList.add('hidden');
        });

        providerSelect.addEventListener('change', () => {
            handleProviderChange(true);
            resetConnectionStatus();
        });
        baseUrlInput.addEventListener('input', resetConnectionStatus);
        apiKeyInput.addEventListener('input', resetConnectionStatus);
        modelSelect.addEventListener('change', resetConnectionStatus);

        refreshModelsBtn.addEventListener('click', handleRefreshModels);
        testConnectionBtn.addEventListener('click', handleTestConnection);
        toggleModelLockBtn.addEventListener('click', handleToggleModelLock);

        sendButton.addEventListener('click', handleSendMessage);
        chatInput.addEventListener('keydown', e => e.key === 'Enter' && (e.preventDefault(), handleSendMessage()));

        deleteModeToggle.addEventListener('click', () => setDeleteMode(true));
        deleteModeCancel.addEventListener('click', () => setDeleteMode(false));
        executeDeleteBtn.addEventListener('click', confirmDelete);

        exportDataBtn.addEventListener('click', handleExportData);
        importDataBtn.addEventListener('click', () => importFileInput.click());
        importFileInput.addEventListener('change', handleImportData);

        cancelGroupCreation.addEventListener('click', () => groupCreatorModal.classList.add('hidden'));
        createGroupBtn.addEventListener('click', handleCreateGroup);

        summarizeChatBtn.addEventListener('click', openSummaryModal);
        cancelSummaryBtn.addEventListener('click', () => summaryModal.classList.add('hidden'));
        generateSummaryBtn.addEventListener('click', handleGenerateSummary);

        worldbookDeleteModeToggle.addEventListener('click', toggleWorldbookDeleteMode);
        worldbookSelectAllBtn.addEventListener('click', handleWorldbookSelectAll);
        worldbookExecuteDeleteBtn.addEventListener('click', handleWorldbookDelete);

        heartSidebarBtn.addEventListener('click', openChatSidebar);
        closeSidebar.addEventListener('click', closeChatSidebar);

        addCategoryBtn.addEventListener('click', () => addCategoryModal.classList.remove('hidden'));
        cancelAddCategoryBtn.addEventListener('click', () => addCategoryModal.classList.add('hidden'));
        saveCategoryBtn.addEventListener('click', handleAddCategory);

        bindEntryBtn.addEventListener('click', handleBindEntry);
        closeEntryModal.addEventListener('click', () => worldbookEntryModal.classList.add('hidden'));
        cancelWorldbookSelection.addEventListener('click', () => worldbookSelectionModal.classList.add('hidden'));
        confirmWorldbookSelection.addEventListener('click', handleConfirmWorldbookSelection);

        selectAvatarBtn.addEventListener('click', () => avatarUploadInput.click());
        avatarUploadInput.addEventListener('change', handleAvatarUpload);
        cancelAvatarUpload.addEventListener('click', () => avatarUploadModal.classList.add('hidden'));
        saveAvatarBtn.addEventListener('click', handleSaveAvatar);
        document.getElementById('upload-contact-avatar').addEventListener('click', () => {
            state.avatarUploadTarget = 'contact-editor';
            avatarUploadModal.classList.remove('hidden');
            avatarPreview.src = contactAvatarInput.value || 'https://i.postimg.cc/Fs8RPSdF/image.png';
        });
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('category-tab')) {
                const category = e.target.dataset.category;
                setWorldbookCategory(category);
            }
        });
        chatMessages.addEventListener('click', (e) => {
             const avatarContainer = e.target.closest('.avatar-upload-container');
             if (avatarContainer) {
                e.preventDefault();
                e.stopPropagation();
                const target =avatarContainer.dataset.target;
                openAvatarUploadModal(target);
             }
        });
    }

    function updateConnectionStatusUI(status, message = '') {
        const statuses = {
            idle: { text: "æœªè¿æ¥", class: "idle" },
            testing: { text: "æµ‹è¯•ä¸­...", class: "testing" },
            connected: { text: message || "å·²è¿æ¥", class: "connected" },
            failed: { text: message || "è¿æ¥å¤±è´¥", class: "failed" },
        };
        const current = statuses[status] || statuses.idle;
        connectionStatusDot.className = `w-2 h-2 rounded-full inline-block mr-1.5 transition-all ${current.class}`;
        connectionStatusText.textContent = current.text;
    }

    function resetConnectionStatus() {
        if (modelSelect.disabled) return;
        updateConnectionStatusUI('idle');
    }

    function handleToggleModelLock() {
        const isLocked = modelSelect.disabled;
        modelSelect.disabled = !isLocked;
        toggleModelLockBtn.textContent = isLocked ? 'ğŸ”’' : 'ğŸ”“';
        if (isLocked) {
            state.apiSettings.connected = false;
            resetConnectionStatus();
        }
    }

    async function handleTestConnection() {
        const provider = providerSelect.value,
              baseUrl = baseUrlInput.value.trim(),
              apiKey = apiKeyInput.value.trim(),
              modelName = modelSelect.value;
        if (!apiKey || !baseUrl || !modelName) {
            showToast('è¯·å¡«å†™æä¾›å•†ã€URLã€Keyå¹¶é€‰æ‹©æ¨¡å‹', "error");
            return;
        }
        updateConnectionStatusUI('testing');
        const result = await testApiConnection(provider, baseUrl, apiKey, modelName);
        if (result.success) {
            updateConnectionStatusUI('connected', `æµ‹è¯•æˆåŠŸ`);
            showToast('API è¿æ¥æµ‹è¯•æˆåŠŸ');
        } else {
            updateConnectionStatusUI('failed', 'æµ‹è¯•å¤±è´¥');
            showToast(`æµ‹è¯•å¤±è´¥: ${result.error}`, 'error');
        }
    }

    async function handleConnectAndSave() {
        const provider = providerSelect.value,
              baseUrl = baseUrlInput.value.trim(),
              apiKey = apiKeyInput.value.trim(),
              modelName = modelSelect.value;
        if (!apiKey || !baseUrl || !modelName) {
            showToast('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'error');
            return;
        }
        updateConnectionStatusUI('testing');
        const result = await testApiConnection(provider, baseUrl, apiKey, modelName);
        if (result.success) {
            state.apiSettings = {
                provider,
                baseUrl,
                apiKey,
                modelName,
                connected: true,
            };
            saveState('apiSettings');
            modelSelect.disabled = true;
            toggleModelLockBtn.textContent = 'ğŸ”’';
            updateConnectionStatusUI('connected', `å·²è¿æ¥è‡³ ${modelName}`);
            showToast('è¿æ¥æˆåŠŸå¹¶å·²ä¿å­˜');
            apiSettingsModal.classList.add('hidden');
        } else {
            state.apiSettings.connected = false;
            saveState('apiSettings');
            updateConnectionStatusUI('failed', 'è¿æ¥å¤±è´¥');
            showToast(`è¿æ¥å¤±è´¥: ${result.error}`, 'error');
        }
    }

    async function testApiConnection(provider, baseUrl, apiKey, modelName) {
        try {
            await fetchAIResponse("system_test", { content: "Hello" });
            return { success: true };
        } catch (e) {
            return { success: false, error: e.message };
        }
    }

    function handleSecurityMethodChange() {
        const method = unlockMethodSelect.value;
        passwordSettingField.classList.toggle('hidden', method !== 'password');
        gestureSettingField.classList.toggle('hidden', method !== 'gesture');
        if (method === 'gesture') {
            patternSettingState = 'setting';
            tempPattern = [];
            settingsPattern.reset();
            gestureSetPrompt.textContent = 'ç»˜åˆ¶è§£é”å›¾æ¡ˆ';
            resetGestureBtn.classList.add('hidden');
        }
    }

    function handleSaveSecuritySettings() {
        const method = unlockMethodSelect.value;
        state.security.method = method;
        if (method === 'password') {
            const newPassword = passwordInput.value;
            if (!/^\d{4}$/.test(newPassword)) return showToast('å¯†ç å¿…é¡»æ˜¯4ä½æ•°å­—');
            state.security.password = newPassword;
            state.security.pattern = [];
        } else if (method === 'gesture') {
            if(patternSettingState === 'done' && tempPattern.length > 0) {
                state.security.pattern = tempPattern;
                state.security.password = '';
            } else if (!state.security.pattern || state.security.pattern.length === 0) {
                return showToast('è¯·å…ˆè®¾ç½®ä¸€ä¸ªæœ‰æ•ˆçš„æ‰‹åŠ¿å›¾æ¡ˆ');
            }
        } else {
            state.security.password = '';
            state.security.pattern = [];
        }
        saveState('security');
        securitySettingsModal.classList.add('hidden');
        showToast('å®‰å…¨è®¾ç½®å·²ä¿å­˜');
        updateLockScreenView();
    }

    function updateLockScreenView() {
        const method = state.security.method;
        slideUnlockContainer.classList.toggle('hidden', method !== 'slide');
        passwordUnlockContainer.classList.toggle('hidden', method !== 'password');
        gestureUnlockContainer.classList.toggle('hidden', method !== 'gesture');
        if(method === 'gesture') {
            gesturePrompt.textContent = 'ç»˜åˆ¶å›¾æ¡ˆä»¥è§£é”';
            gesturePrompt.classList.remove('text-red-400');
            lockScreenPattern.reset();
        }
        if (lockScreen.style.display === 'none') {
            lockScreen.style.display = 'flex';
        }
    }

    function generateKeypad() {
        const keys = [1, 2, 3, 4, 5, 6, 7, 8, 9, '', 0, 'del'];
        keypad.innerHTML = keys.map(key => {
            if (key === 'del') {
                return `<button data-key="del" class="keypad-key text-xl">åˆ é™¤</button>`;
            }
            if (key === '') {
                return `<div></div>`;
            }
            return `<button data-key="${key}" class="keypad-key w-14 h-14 rounded-full bg-white/20 text-2xl font-light hover:bg-white/30 flex items-center justify-center">${key}</button>`;
        }).join('');
    }

    async function fetchAIResponse(promptType, context = {}) {
        const { provider, baseUrl, apiKey, modelName, connected } = state.apiSettings;

        if (!connected && promptType !== 'system_test' && promptType !== 'weibo') {
            throw new Error('AIæœåŠ¡æœªè¿æ¥ï¼Œè¯·æ£€æŸ¥è®¾ç½®');
        }

        const { main, single, group, summary, jailbreak, weibo, weibo_follow } = state.promptSettings;
        let systemPromptContent = '';
        let messages = [];
        const user = state.userProfile;

        let boundWorldbookContent = '';
        if (state.currentChatId && state.boundWorldbookEntries[state.currentChatId]) {
            const boundEntries = state.boundWorldbookEntries[state.currentChatId];
            boundEntries.forEach(entryId => {
                const entry = state.worldbook.find(w => w.id === entryId);
                if (entry) {
                    boundWorldbookContent += `\n\n[ç›¸å…³ä¸–ç•Œä¹¦æ¡ç›®: ${entry.title}]\n${entry.content}`;
                }
            });
        }

        switch(promptType) {
            case 'system_test':
                systemPromptContent = 'Respond with "OK" if you receive this message.';
                messages = [{ role: 'user', content: context.content || "Hello" }];
                break;
            case 'summary':
                const chatHistoryForSummary = context.chatHistory || [];
                const chatTargetForSummary = state.isGroupChat
                    ? state.groups.find(g => g.id === state.currentChatId)
                    : state.contacts.find(c => c.id === state.currentChatId);
                const chatLog = chatHistoryForSummary.map(m => {
                    let authorName = 'æœªçŸ¥';
                    if (m.authorId === 'user') {
                        authorName = user.name;
                    } else if (chatTargetForSummary) {
                        const member = state.isGroupChat
                            ? chatTargetForSummary.members.find(mem => mem.id === m.authorId)
                            : chatTargetForSummary;
                        if (member) authorName = member.name;
                    }
                    return `${authorName}: ${m.content}`;
                }).join('\n');
                systemPromptContent = summary
                    .replace(/{user_name}/g, user.name)
                    .replace(/{char_name}/g, chatTargetForSummary?.name || 'æœªçŸ¥') + `\n\nChat Log:\n${chatLog}`;
                messages = [{ role: 'user', content: 'Please summarize the chat according to your instructions.' }];
                break;
            case 'weibo':
        systemPromptContent = weibo.replace('{followed_ai_list}', JSON.stringify(context.followed_ai_list));
        messages = [{ role: 'user', content: 'ç°åœ¨ï¼Œè¯·æ ¹æ® `{followed_ai_list}` ç”Ÿæˆå†…å®¹ã€‚' }];
        break;
        case 'weibo_follow':
    // ç¡®ä¿ weibo_follow æç¤ºè¯å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œå°±ä½¿ç”¨é€šç”¨çš„ weibo æç¤ºè¯ä½œä¸ºå¤‡ç”¨
    const followPrompt = state.promptSettings.weibo_follow || state.promptSettings.weibo;
    systemPromptContent = followPrompt.replace('{followed_ai_list}', JSON.stringify(context.followed_ai_list));
    messages = [{ role: 'user', content: 'ç°åœ¨ï¼Œè¯·æ ¹æ® `{followed_ai_list}` ç”Ÿæˆå…³æ³¨é¡µçš„å¾®åšå†…å®¹ã€‚' }];
    break;
            default: // Chat
                let chatTarget;
                let personaSection = '';

                // åœ¨ fetchAIResponse å‡½æ•°çš„ç¾¤èŠéƒ¨åˆ†æ›´æ–°ï¼š
let activeChatPrompt;
if (state.isGroupChat) {
    // æ ¹æ®å½“å‰èŠå¤©æ¨¡å¼é€‰æ‹©å¯¹åº”çš„æç¤ºè¯
    activeChatPrompt = state.chatMode === 'online' 
        ? (state.promptSettings.group_online || group)
        : (state.promptSettings.group_offline || group);
} else {
    activeChatPrompt = single;
}
const basePrompt = [main, activeChatPrompt
    .replace('{group_prompt}', state.promptSettings.group)
    .replace('{chat_mode}', state.chatMode) // æ·»åŠ æ¨¡å¼å‚æ•°
    , jailbreak].filter(p => p && p.trim() !== '').join('\n\n');
    
                if(state.isGroupChat) {
                    chatTarget = state.groups.find(g => g.id === state.currentChatId);
                    if (chatTarget && chatTarget.members) {
                        const aiMembers = chatTarget.members;
                        const memberPersonas = aiMembers.map(member =>
                            `### è§’è‰²: ${member.name}\n- **äººè®¾**: ${member.persona || 'æ— ç‰¹å®šäººè®¾'}`
                        ).join('\n');

                        const memberList = aiMembers.map(m => m.name).join(', ');

                        // åœ¨ personaSection ä¸­æ·»åŠ æ¨¡å¼ä¿¡æ¯
personaSection = `\n\nä½ æ­£åœ¨ä¸€ä¸ªåä¸º"${chatTarget.name}"çš„ç¾¤èŠä¸­ã€‚è¿™ä¸ªç¾¤èŠé‡Œæœ‰ä½ ï¼ˆä½œä¸ºAIï¼‰å’Œä¸€ä½äººç±»ç”¨æˆ·"${user.name}"ã€‚\n\nã€äººç±»ç”¨æˆ·çš„ä¿¡æ¯ã€‘\n- åå­—: ${user.name}\n- äººè®¾: ${user.persona || 'ä¸€ä¸ªæ­£åœ¨ä¸ä½ äº’åŠ¨çš„äºº'}\n\nä½ å¿…é¡»åŒæ—¶æ‰®æ¼”ä»¥ä¸‹æ‰€æœ‰AIè§’è‰²ï¼Œå¹¶æ ¹æ®ä»–ä»¬å„è‡ªçš„äººè®¾ä¸"${user.name}"è¿›è¡Œäº’åŠ¨ã€‚\n\nã€å½“å‰èŠå¤©æ¨¡å¼ã€‘: ${state.chatMode === 'online' ? 'çº¿ä¸Šæ¨¡å¼ï¼ˆçº¯å¯¹è¯ï¼‰' : 'çº¿ä¸‹æ¨¡å¼ï¼ˆå¯åŒ…å«åŠ¨ä½œå’Œå†…å¿ƒæƒ³æ³•ï¼‰'}\n\nã€ä½ éœ€è¦æ‰®æ¼”çš„AIè§’è‰²åˆ—è¡¨ã€‘\n${memberPersonas}`;
                    }
                } else {
                    chatTarget = state.contacts.find(c => c.id === state.currentChatId);
                    if (chatTarget) {
                         personaSection = `\n\nä½ æ­£åœ¨ä¸"${user.name}"è¿›è¡Œä¸€å¯¹ä¸€èŠå¤©ã€‚ä½ çš„è§’è‰²æ˜¯"${chatTarget.name}"ï¼Œä½ éœ€è¦ä¸¥æ ¼éµå®ˆä»¥ä¸‹äººè®¾è¿›è¡Œå›å¤ã€‚\n\n### ä½ çš„è§’è‰²ä¿¡æ¯\n- **äººè®¾**: ${chatTarget.persona || 'æ— ç‰¹å®šäººè®¾'}`;
                    }
                }

                systemPromptContent = basePrompt
                    .replace(/{char_name}/g, chatTarget?.name || 'æœªçŸ¥')
                    .replace(/{group_name}/g, chatTarget?.name || 'ç¾¤èŠ')
                    .replace(/{member_list}/g, chatTarget?.members?.map(m => m.name).join(', ') || 'æœªçŸ¥')
                    .replace(/{user_name}/g, user.name || 'ä½ ')
                    .replace(/{user_persona}/g, user.persona || 'ä¸€ä¸ªæ­£åœ¨å’Œæˆ‘èŠå¤©çš„äºº')
                    + personaSection
                    + boundWorldbookContent;

                messages = state.chatHistory[state.currentChatId] || [];
                break;
        }

        const headers = { 'Content-Type': 'application/json' };
        let url, body, method = 'POST';

        const currentProvider = (promptType === 'system_test') ? providerSelect.value : provider;
        const currentBaseUrl = (promptType === 'system_test') ? baseUrlInput.value.trim() : baseUrl;
        const currentApiKey = (promptType === 'system_test') ? apiKeyInput.value.trim() : apiKey;
        const currentModelName = (promptType === 'system_test') ? modelSelect.value : modelName;

        switch(currentProvider) {
             case 'openai':
                 headers['Authorization'] = `Bearer ${currentApiKey}`;
                 url = `${getSanitizedOpenAIBase(currentBaseUrl)}/chat/completions`;
                 body = JSON.stringify({
                     model: currentModelName,
                     messages: [{ role: 'system', content: systemPromptContent }, ...messages],
                     stream: false
                 });
                 break;
             case 'gemini':
                 url = `${currentBaseUrl}/models/${currentModelName}:generateContent?key=${currentApiKey}`;
                 body = JSON.stringify({
                     contents: [{ role: 'system', parts:[{text: systemPromptContent}]}, ...messages.map(m => ({
                         parts: [{ text: m.content }],
                         role: m.role === 'user' ? 'user' : 'model'
                     }))],
                     generationConfig: { "stopSequences": [] }
                 });
                 break;
             case 'claude':
                 headers['x-api-key'] = currentApiKey;
                 headers['anthropic-version'] = '2023-06-01';
                 url = `${currentBaseUrl}/messages`;
                 body = JSON.stringify({
                     model: currentModelName,
                     messages,
                     system: systemPromptContent,
                     max_tokens: 4096
                 });
                 break;
             default:
                 throw new Error('ä¸æ”¯æŒçš„AIæä¾›å•†');
        }

        const response = await fetch(url, { method, headers, body });
        if (!response.ok) {
            let errorMsg = `API Error: ${response.status}`;
            try {
                const errorData = await response.json();
                errorMsg = errorData.error?.message || JSON.stringify(errorData);
            } catch {}
            throw new Error(errorMsg);
        }

        const data = await  response.json();
        switch(currentProvider) {
             case 'openai':
                 return data.choices[0].message.content;
             case 'gemini':
                if (data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts) {
                    return data.candidates[0].content.parts[0].text;
                }
                console.error("Gemini API response format error:", data);
                throw new Error('è§£æGeminiå“åº”å¤±è´¥: æ ¼å¼ä¸æ­£ç¡®');
             case 'claude':
                 return data.content[0].text;
             default:
                 throw new Error('è§£æå“åº”å¤±è´¥');
        }
    }

    function unlockPhone() {
        lockScreen.style.display = 'none';
        homeScreen.classList.remove('hidden');
        currentPassword_ = '';
        updatePasswordDisplay();
        resetSlider();
    }

    function resetSlider() {
        unlockSliderThumb.style.transition = 'transform 0.3s';
        unlockSliderThumb.style.transform = 'translateX(0px)';
        setTimeout(() => {
            unlockSliderThumb.style.transition = '';
        }, 300);
    }

    function handleKeypadInput(key) {
        if (key === 'del') {
            currentPassword_ = currentPassword_.slice(0, -1);
        } else if (currentPassword_.length < 4) {
            currentPassword_ += key;
        }
        updatePasswordDisplay();
        if (currentPassword_.length === 4) {
            if (currentPassword_ === state.security.password) {
                setTimeout(unlockPhone, 100);
            } else {
                passwordDisplay.classList.add('shake');
                passwordPrompt.textContent = "å¯†ç é”™è¯¯";
                passwordPrompt.classList.add('text-red-400');
                if ('vibrate' in navigator) navigator.vibrate(100);
                setTimeout(() => {
                    passwordDisplay.classList.remove('shake');
                    passwordPrompt.textContent = "è¾“å…¥å¯†ç ";
                    passwordPrompt.classList.remove('text-red-400');
                    currentPassword_ = '';
                    updatePasswordDisplay();
                }, 800);
            }
        }
    }

    function updatePasswordDisplay() {
        const dots = passwordDisplay.children;
        for(let i = 0; i < dots.length; i++) {
            dots[i].classList.toggle('filled', i < currentPassword_.length);
        }
    }

    window.showHomeScreen = () => {
        homeScreen.classList.remove('hidden');
        appScreens.forEach(s => s.classList.remove('active'));
    };

    window.showApp = appId => {
        homeScreen.classList.add('hidden');
        document.getElementById(appId)?.classList.add('active');
        if (appId === 'wechat-app') {
            showWechatListView();
            renderWechatContactList();
        }
        if (appId === 'worldbook-app') {
            renderWorldbook();
        }
        if (appId === 'weibo-app') {
            openWeiboApp();
        }
    };

    window.showWechatListView = () => {
    wechatListView.classList.remove('hidden');
    wechatChatView.classList.add('hidden');
    state.currentChatId = null;
    if (state.deleteMode) setDeleteMode(false);

    // æ–°å¢é€»è¾‘ï¼šæ£€æŸ¥å¹¶å…³é—­ä¾§è¾¹æ 
    if (chatSidebar.classList.contains('active')) {
        closeChatSidebar();
    }

    renderWechatContactList();
};

    window.openContactEditor = (contactId) => {
        userNameInput.value = state.userProfile.name;
        userAgeInput.value = state.userProfile.age;
        userGenderInput.value = state.userProfile.gender;
        userAvatarInput.value = state.userProfile.avatar;
        userPersonaInput.value = state.userProfile.persona;

        if (contactId) {
            const contact = state.contacts.find(c => c.id === contactId);
            editorTitle.textContent = 'ç¼–è¾‘è”ç³»äºº';
            contactIdInput.value = contact?.id || '';
            contactNameInput.value = contact?.name || '';
            contactAgeInput.value = contact?.age || '';
            contactGenderInput.value = contact?.gender || 'å¥³æ€§';
            contactAvatarInput.value = contact?.avatar || '';
            contactPersonaInput.value = contact?.persona || '';
            deleteContactBtn.classList.remove('hidden');
            contactFields.classList.remove('hidden');
        } else {
            editorTitle.textContent = 'æ·»åŠ è”ç³»äºº';
            contactIdInput.value = '';
            contactNameInput.value = '';
            contactAgeInput.value = '';
            contactGenderInput.value = 'å¥³æ€§';
            contactAvatarInput.value = '';
            contactPersonaInput.value = '';
            deleteContactBtn.classList.add('hidden');
            contactFields.classList.remove('hidden');
        }
        contactEditorModal.classList.remove('hidden');
    };

    window.openChat = (chatId, isGroup) => {
        state.currentChatId = chatId;
        state.isGroupChat = isGroup;
        let chatTarget;
        if (isGroup) {
            chatTarget = state.groups.find(g => g.id === chatId);
        } else {
            chatTarget = state.contacts.find(c => c.id === chatId);
        }
        if (!chatTarget) return;
        chatContactName.textContent = chatTarget.name;
        chatMessages.innerHTML = '';
        wechatListView.classList.add('hidden');
        wechatChatView.classList.remove('hidden');
        if(state.deleteMode) setDeleteMode(false);
        (state.chatHistory[chatId] || []).forEach((msg, index) => addMessageToUI(msg, index));
    };

    function showToast(message, type = 'info') {
        toast.textContent = message;
        const colors = { info: 'bg-black/70', error: 'bg-red-500' };
        toast.className = `fixed bottom-24 left-1/2 -translate-x-1/2 text-white text-sm rounded-full px-4 py-2 z-50 fade-in ${colors[type]}`;
        toast.classList.remove('hidden');
        setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    function updateClock() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const month = now.getMonth() + 1;
        const day = now.getDate();
        const weekday = now.toLocaleString('zh-CN', { weekday: 'long' });
        timeDisplay.textContent = `${hours}:${minutes}`;
        if (lockScreen.style.display !== 'none') {
            lockTime.textContent = `${hours}:${minutes}`;
            lockDate.textContent = `${month}æœˆ${day}æ—¥ ${weekday}`;
        }
    }

    function renderApps() {
        const ALL_APPS = [
            { id: 'wechat', name: 'å¾®ä¿¡', icon: 'ğŸ’¬', screenId: 'wechat-app', inDock: true },
            { id: 'contacts', name: 'é€šè®¯å½•', icon: 'ğŸ‘¥', screenId: 'contacts-app', inDock: true },
            { id: 'worldbook', name: 'ä¸–ç•Œä¹¦', icon: 'ğŸ“–', screenId: 'worldbook-app', inDock: false },
            { id: 'weibo', name: 'å¾®åš', icon: 'ğŸ“±', screenId: 'weibo-app', inDock: false },
            { id: 'settings', name: 'è®¾ç½®', icon: 'âš™ï¸', screenId: 'settings-app', inDock: true },
        ];
        appGrid.innerHTML = '';
        dock.innerHTML = '';
        ALL_APPS.forEach(app => {
            const iconHtml = `<div class="flex flex-col items-center" onclick="showApp('${app.screenId}')"><div class="w-16 h-16 bg-white rounded-2xl flex items-center justify-center text-4xl shadow-md cursor-pointer">${app.icon}</div><span class="app-icon-label text-white text-xs mt-1.5">${app.name}</span></div>`;
            if (app.inDock) {
                dock.innerHTML += iconHtml.replace('w-16 h-16', 'w-12 h-12').replace('text-4xl','text-2xl').replace('class="app-icon-label text-white text-xs mt-1.5"', '');
            } else {
                appGrid.innerHTML  += iconHtml;
            }
        });
    }

    function renderContactsList() {
        contactsList.innerHTML = state.contacts.length === 0 ?
            `<p class="text-center text-gray-400 mt-8">ç‚¹å‡»å³ä¸Šè§’ '+' æ·»åŠ ç¬¬ä¸€ä¸ªè”ç³»äºº</p>` :
            state.contacts.map(contact =>
                `<div class="contact-item flex items-center p-4 border-b cursor-pointer hover:bg-gray-50" data-contact-id="${contact.id}">
                    <img src="${contact.avatar || 'https://i.postimg.cc/Fs8RPSdF/image.png'}" alt="${contact.name}" class="w-12 h-12 rounded-full mr-4 object-cover">
                    <span class="text-lg">${contact.name}</span>
                </div>`
            ).join('');
        document.querySelectorAll('#contacts-list .contact-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const contactId = Number(item.dataset.contactId);
                openChat(contactId, false);
            });
        });
    }

    function bindContactListEvents() {
        document.querySelectorAll('#contacts-list .contact-item').forEach(item => {
            let pressTimer, longPressTriggered = false;
            const contactId = Number(item.dataset.contactId);
            const onPointerDown = (e) => {
                longPressTriggered = false;
                pressTimer = window.setTimeout(() => {
                    longPressTriggered = true;
                    if ('vibrate' in navigator) navigator.vibrate(50);
                    handleDeleteContactById(contactId);
                }, 800);
            };
            const onPointerUp = () => clearTimeout(pressTimer);
            const onClick = () => {
                if (!longPressTriggered) openContactEditor(contactId);
            };
            item.addEventListener('mousedown', onPointerDown);
            item.addEventListener('touchstart', onPointerDown);
            item.addEventListener('mouseup', onPointerUp);
            item.addEventListener('touchend', onPointerUp);
            item.addEventListener('mouseleave', onPointerUp);
            item.addEventListener('click', onClick);
        });
    }

    function handleDeleteGroupById(groupId, callback) {
        const group = state.groups.find(g => g.id === groupId);
        if (!group) return;

        if (confirm(`ç¡®å®šè¦åˆ é™¤ç¾¤èŠ "${group.name}" å—ï¼Ÿç›¸å…³çš„èŠå¤©è®°å½•éƒ½ä¼šè¢«åˆ é™¤ã€‚`)) {
            state.groups = state.groups.filter(g => g.id !== groupId);
            delete state.chatHistory[groupId];
            delete state.boundWorldbookEntries[groupId];
            saveState('groups');
            saveState('chatHistory');
            saveState('boundWorldbookEntries');
            renderWechatContactList();
            showToast('ç¾¤èŠå·²åˆ é™¤');
            if (callback) callback();
        }
    }

    function renderWechatContactList() {
        const chats = [...state.groups, ...state.contacts];
        const sortedChats = chats.sort((a,b) => {
            const lastMsgA = state.chatHistory[a.id]?.slice(-1)[0]?.timestamp || 0;
            const lastMsgB = state.chatHistory[b.id]?.slice(-1)[0]?.timestamp || 0;
            return lastMsgB - lastMsgA;
        });

        wechatContactList.innerHTML = sortedChats.length === 0 ?
            `<p class="text-center text-gray-400 mt-8">è¿˜æ²¡æœ‰ä»»ä½•èŠå¤©</p>` :
            sortedChats.map(chat => {
                const lastMsg = state.chatHistory[chat.id]?.slice(-1)[0];
                const isGroup = 'members' in chat;
                let lastMsgContent = lastMsg?.content || '';
                const stickerMatch = lastMsgContent.match(/\[(?:å¯¹æ–¹æ¶ˆæ¯|ç¾¤èŠæ¶ˆæ¯)\|.*?\|.*?\|è¡¨æƒ…åŒ…\|.*?\]/);
                if (stickerMatch) lastMsgContent = '[è¡¨æƒ…]';

                const avatar = isGroup ?
                    (chat.avatar || `https://avatar.vercel.sh/group${chat.id}`) :
                    (chat.avatar || 'https://i.postimg.cc/Fs8RPSdF/image.png');

                return `<div class="wechat-chat-item flex items-center p-4 border-b cursor-pointer hover:bg-gray-50" data-chat-id="${chat.id}" data-is-group="${isGroup}">
                            <img src="${avatar}" alt="${chat.name}" class="w-12 h-12 rounded-full mr-4 object-cover">
                            <div class="flex-grow pointer-events-none">
                                <p class="text-lg font-medium">${chat.name}</p>
                                <p class="text-sm text-gray-500 truncate">${lastMsgContent.substring(0, 20)}</p>
                            </div>
                        </div>`;
            }).join('');
        document.querySelectorAll('.wechat-chat-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const chatId = Number(item.dataset.chatId);
                const isGroup = item.dataset.isGroup === 'true';
                openChat(chatId, isGroup);
            });
        });

        document.querySelectorAll('.wechat-chat-item').forEach(item => {
            let pressTimer;
            let longPressTriggered = false;
            const chatId = Number(item.dataset.chatId);
            const isGroup = item.dataset.isGroup === 'true';

            const onPointerDown = (e) => {
                longPressTriggered = false;
                pressTimer = window.setTimeout(() => {
                    longPressTriggered = true;
                    if ('vibrate' in navigator) navigator.vibrate(50);
                    if (isGroup) {
                        handleDeleteGroupById(chatId);
                    }
                }, 800);
            };
            const onPointerUp = () => clearTimeout(pressTimer);
            const onClick = (e) => {
                if (!longPressTriggered) {
                    openChat(chatId, isGroup);
                }
            };
            item.addEventListener('mousedown', onPointerDown);
            item.addEventListener('touchstart', onPointerDown);
            item.addEventListener('mouseup', onPointerUp);
            item.addEventListener('touchend', onPointerUp);
            item.addEventListener('mouseleave', onPointerUp);
            item.addEventListener('click', onClick);
        });
    }

    function updateModelOptions() {
        const provider = providerSelect.value;
        const models = state.availableModels[provider] || [];
        modelSelect.innerHTML = models.length > 0 ?
            models.map(m => `<option value="${m.id}">${m.name}</option>`).join('') :
            `<option value="">æ— å¯ç”¨æ¨¡å‹</option>`;
        if (state.apiSettings.provider === provider) {
            modelSelect.value = state.apiSettings.modelName;
        }
        if(models.length === 0) {
            modelSelect.disabled = true;
            toggleModelLockBtn.textContent = 'ğŸ”’';
        }
    }

    function addMessageToUI(msgData, messageIndex) {
        const isUser = msgData.role === 'user';
        let author;

        if (isUser) {
            author = state.userProfile;
        } else {
            author = state.contacts.find(c => c.id === msgData.authorId);
            if (!author && state.isGroupChat && state.currentChatId) {
                const group = state.groups.find(g => g.id === state.currentChatId);
                if (group && group.members) {
                    author = group.members.find(m => m.id === msgData.authorId);
                }
            }
            
            if (!author) {
                author = {
                    name: msgData.authorName || 'æœªçŸ¥ç”¨æˆ·',
                    avatar: 'https://i.postimg.cc/Fs8RPSdF/image.png'
                };
            }
        }

        const msgWrapper = document.createElement('div');
        msgWrapper.className = `flex w-full items-start gap-2.5 message-item ${isUser ? 'justify-end' : 'justify-start'}`;

        const checkbox = `<input type="checkbox" class="delete-checkbox hidden w-5 h-5 accent-blue-500 self-center" data-index="${messageIndex}">`;
        const avatar= `<div class="avatar-upload-container cursor-pointer" data-target="${isUser ? 'user' : author.id}">
            <img src="${author.avatar || 'https://i.postimg.cc/Fs8RPSdF/image.png'}" alt="avatar" class="w-8 h-8 rounded-full object-cover">
        </div>`;

        let contentHtml;
        const msgContent = msgData.content;
        const stickerRegex = /\[(?:å¯¹æ–¹æ¶ˆæ¯|ç¾¤èŠæ¶ˆæ¯)\|.*?\|.*?\|è¡¨æƒ…åŒ…\|(https:\/\/i\.postimg\.cc\/[a-zA-Z0-9]+\/image\.(?:gif|jpg|png|webp))\]/;
        const redPacketRegex = /\[(?:å¯¹æ–¹æ¶ˆæ¯|ç¾¤èŠæ¶ˆæ¯)\|.*?\|.*?\|çº¢åŒ…\|(\d+)\]/;
        const voiceRegex = /\[(?:å¯¹æ–¹æ¶ˆæ¯|ç¾¤èŠæ¶ˆæ¯)\|.*?\|.*?\|è¯­éŸ³\|(.*?)\]/;

        let match;
        if (match = msgContent.match(stickerRegex)) {
            contentHtml = `<img src="${match[1]}" class="max-w-[120px] rounded-lg" alt="sticker">`;
        } else if (match = msgContent.match(redPacketRegex)) {
            contentHtml = `<div class="bg-red-500 text-white p-3 rounded-lg w-48 cursor-pointer hover:bg-red-600"><p class="font-bold">çº¢åŒ…</p><p class="text-sm">ç‚¹å‡»é¢†å–</p></div>`;
        } else if (match = msgContent.match(voiceRegex)) {
            contentHtml = `<div class="bg-white text-black p-3 rounded-lg flex items-center gap-2 cursor-pointer hover:bg-gray-200"><span>â–¶</span><span>${match[1]}</span></div>`;
        } else {
             contentHtml = `<div class="max-w-[70%] rounded-xl px-4 py-2.5 text-base whitespace-pre-wrap ${isUser ? 'bg-blue-500 text-white' : 'bg-white text-black'}">${msgContent}</div>`;
        }

        const messageBubble = `<div class="flex flex-col ${isUser ? 'items-end' : 'items-start'}">
            ${state.isGroupChat && !isUser ? `<span class="text-xs text-gray-500 mb-1 ml-1">${author.name}</span>` : ''}
            <div class="flex items-start gap-2.5 ${isUser ? 'flex-row-reverse' : 'flex-row'}">
                ${avatar}
                ${contentHtml}
            </div>
        </div>`;

        msgWrapper.innerHTML = `
            ${!isUser ? checkbox : ''}
            <div class="flex-grow">${messageBubble}</div>
            ${isUser ? checkbox : ''}
        `;

        chatMessages.appendChild(msgWrapper);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function setDeleteMode(enable) {
        state.deleteMode = enable;
        deleteModeToggle.classList.toggle('hidden', enable);
        summarizeChatBtn.classList.toggle('hidden', enable);
        deleteModeCancel.classList.toggle('hidden', !enable);
        chatFooter.classList.toggle('hidden', enable);
        deleteFooter.classList.toggle('hidden', !enable);
        document.querySelectorAll('.delete-checkbox').forEach(cb => {
            cb.classList.toggle('hidden', !enable);
            cb.checked = false;
        });
        if (!enable) {
            state.selectedMessages.clear();
            updateDeleteButton();
        }
    }

    function confirmDelete() {
        if (state.selectedMessages.size > 0) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${state.selectedMessages.size} æ¡æ¶ˆæ¯å—ï¼Ÿ`)) {
                deleteSelectedMessages();
            }
        }
    }

    function updateDeleteButton() {
        const count = state.selectedMessages.size;
        executeDeleteBtn.disabled = count === 0;
        executeDeleteBtn.textContent = count > 0 ? `åˆ é™¤ (${count})` : 'åˆ é™¤';
    }

    chatMessages.addEventListener('change', (e) => {
        if (e.target.classList.contains('delete-checkbox')) {
            const index = parseInt(e.target.dataset.index, 10);
            if (e.target.checked) {
                state.selectedMessages.add(index);
            } else {
                state.selectedMessages.delete(index);
            }
            updateDeleteButton();
        }
    });

    function deleteSelectedMessages() {
        const chatId = state.currentChatId;
        if (!chatId || !state.chatHistory[chatId]) return;
        const newHistory = state.chatHistory[chatId].filter((_, index) => !state.selectedMessages.has(index));
        state.chatHistory[chatId] = newHistory;
        saveState('chatHistory');
        setDeleteMode(false);
        openChat(chatId, state.isGroupChat);
        showToast('æ¶ˆæ¯å·²åˆ é™¤');
    }

    function showTypingIndicator() {
        if(document.getElementById('typing-indicator')) return;
        const typingEl = document.createElement('div');
        typingEl.id = 'typing-indicator';
        typingEl.className = 'flex items-start gap-2.5 w-full';
        typingEl.innerHTML = `<div class="max-w-[70%] rounded-xl px-4 py-2.5 bg-white text-black"><div class="flex items-center space-x-1"><span class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay:0s"></span><span class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay:0.2s"></span><span class="w-2 h-2 bg-gray-400 rounded-full animate-pulse" style="animation-delay:0.4s"></span></div></div>`;
        chatMessages.appendChild(typingEl);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function removeTypingIndicator() {
        document.getElementById('typing-indicator')?.remove();
    }

    function handleSaveContactOrUser() {
        state.userProfile = {
            ...state.userProfile,
            name: userNameInput.value.trim(),
            age: userAgeInput.value.trim(),
            gender: userGenderInput.value,
            avatar: userAvatarInput.value.trim(),
            persona: userPersonaInput.value.trim()
        };
        saveState('userProfile');

        if (contactIdInput.value) {
            const name = contactNameInput.value.trim();
            if (!name) return showToast('è§’è‰²å§“åä¸èƒ½ä¸ºç©º');
            const id = Number(contactIdInput.value);
            const index = state.contacts.findIndex(c => c.id === id);
            if (index > -1) {
                state.contacts[index] = {
                    ...state.contacts[index],
                    name,
                    age: contactAgeInput.value.trim(),
                    gender: contactGenderInput.value,
                    avatar: contactAvatarInput.value.trim(),
                    persona: contactPersonaInput.value.trim()
                };
                saveState('contacts');
                showToast('è”ç³»äººä¸ä¸ªäººèµ„æ–™å·²æ›´æ–°');
            }
        } else if (contactNameInput.value.trim()) {
            const contactId = Date.now() + Math.floor(Math.random() * 1000);
            const contactData = {
                id: contactId,
                name: contactNameInput.value.trim(),
                age: contactAgeInput.value.trim(),
                gender: contactGenderInput.value,
                avatar: contactAvatarInput.value.trim(),
                persona: contactPersonaInput.value.trim()
            };
            state.contacts.push(contactData);
            saveState('contacts');
            showToast('è”ç³»äººä¸ä¸ªäººèµ„æ–™å·²ä¿å­˜');
        } else {
             showToast('ä¸ªäººèµ„æ–™å·²ä¿å­˜');
        }
        renderContactsList();
        bindContactListEvents();
        contactEditorModal.classList.add('hidden');
    }

    function handleDeleteContact() {
        if (contactIdInput.value) {
            handleDeleteContactById(Number(contactIdInput.value), () => contactEditorModal.classList.add('hidden'));
        }
    }

    function handleDeleteContactById(id, callback) {
        if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤è”ç³»äººå—ï¼Ÿç›¸å…³çš„èŠå¤©è®°å½•éƒ½ä¼šè¢«åˆ é™¤ã€‚')) {
            state.contacts = state.contacts.filter(c => c.id != id);
            delete state.chatHistory[id];
            saveState('contacts');
            saveState('chatHistory');
            renderContactsList();
            bindContactListEvents();
            renderWechatContactList();
            showToast('å·²åˆ é™¤');
            if(callback) callback();
        }
    }
    
    // ä¸ºå•ä¸ªè§’è‰²è·å–å›å¤çš„å‡½æ•°
async function fetchSingleCharacterResponse(prompt) {
    const { provider, baseUrl, apiKey, modelName } = state.apiSettings;

    const headers = { 'Content-Type': 'application/json' };
    let url, body;

    switch(provider) {
        case 'openai':
            headers['Authorization'] = `Bearer ${apiKey}`;
            url = `${getSanitizedOpenAIBase(baseUrl)}/chat/completions`;
            body = JSON.stringify({
                model: modelName,
                messages: [{ role: 'system', content: prompt }], // æ³¨æ„ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥æŠŠä¸ºè§’è‰²å®šåˆ¶çš„å®Œæ•´å‰§æœ¬ï¼ˆpromptï¼‰ä½œä¸ºsystem message
                stream: false
            });
            break;
        case 'gemini':
            url = `${baseUrl}/models/${modelName}:generateContent?key=${apiKey}`;
            body = JSON.stringify({
                // Gemini éœ€è¦å°† system prompt å’Œ user message åˆ†å¼€
                contents: [
                    { role: 'system', parts:[{text: prompt }]},
                    { role: 'user', parts: [{ text: 'è¯·æ ¹æ®ä½ çš„è§’è‰²è®¾å®šè¿›è¡Œå›å¤ã€‚' }] } // ç»™ä¸€ä¸ªé€šç”¨çš„è§¦å‘æŒ‡ä»¤
                ],
                generationConfig: { "stopSequences": [] }
            });
            break;
        case 'claude':
            headers['x-api-key'] = apiKey;
            headers['anthropic-version'] = '2023-06-01';
            url = `${baseUrl}/messages`;
            body = JSON.stringify({
                model: modelName,
                system: prompt, // Claude ç›´æ¥æ”¯æŒ system å‚æ•°
                messages: [{ role: 'user', content: 'è¯·æ ¹æ®ä½ çš„è§’è‰²è®¾å®šè¿›è¡Œå›å¤ã€‚'}],
                max_tokens: 4096
            });
            break;
        default:
            throw new Error('ä¸æ”¯æŒçš„AIæä¾›å•†');
    }

    const response = await fetch(url, { method: 'POST', headers, body });
    if (!response.ok) {
        let errorMsg = `API Error: ${response.status}`;
        try {
            const errorData = await response.json();
            errorMsg = errorData.error?.message || JSON.stringify(errorData);
        } catch {}
        throw new Error(errorMsg);
    }

    const data = await response.json();
    switch(provider) {
        case 'openai':
            return data.choices[0].message.content;
        case 'gemini':
            if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts) {
                return data.candidates[0].content.parts[0].text;
            }
            throw new Error('è§£æGeminiå“åº”å¤±è´¥');
        case 'claude':
            return data.content[0].text;
        default:
            throw new Error('è§£æå“åº”å¤±è´¥');
    }
}

              async function handleSendMessage() {
    const content = chatInput.value.trim();
    if (!content || !state.currentChatId) return;

    if (!state.chatHistory[state.currentChatId]) {
        state.chatHistory[state.currentChatId] = [];
    }

    // 1. å°†ç”¨æˆ·çš„æ¶ˆæ¯æ·»åŠ åˆ°å†å²è®°å½•å’ŒUI
    const newUserMessage = { role: 'user', content, authorId: 'user', authorName: state.userProfile.name, timestamp: Date.now() };
    state.chatHistory[state.currentChatId].push(newUserMessage);
    saveState('chatHistory');
    addMessageToUI(newUserMessage, state.chatHistory[state.currentChatId].length - 1);
    chatInput.value = '';

    showTypingIndicator(); // æ˜¾ç¤º "æ­£åœ¨è¾“å…¥..."

    try {
        // 2. ç»Ÿä¸€è°ƒç”¨ fetchAIResponse è·å–AIçš„å›å¤
        const aiResponseText = await fetchAIResponse('chat');

        removeTypingIndicator(); // ç§»é™¤ "æ­£åœ¨è¾“å…¥..."

        // 3. ã€æ ¸å¿ƒå‡çº§ã€‘ç›´æ¥å°†AIè¿”å›çš„æ–‡æœ¬è§£æä¸ºJSONæ•°ç»„
        let processedMessages = [];
        try {
            // å°è¯•ç›´æ¥è§£æJSON
            processedMessages = JSON.parse(aiResponseText);
            // ç¡®ä¿è§£æå‡ºæ¥çš„æ˜¯ä¸€ä¸ªæ•°ç»„
            if (!Array.isArray(processedMessages)) {
                 throw new Error("AI did not return a valid JSON array.");
            }
        } catch (e) {
            console.error("Failed to parse AI response as JSON:", e);
            console.error("Raw AI response:", aiResponseText);
            // å¦‚æœJSONè§£æå¤±è´¥ï¼Œä½œä¸ºåå¤‡æ–¹æ¡ˆï¼Œæˆ‘ä»¬ä»ç„¶å°è¯•æŒ‰æ—§æ–¹å¼å¤„ç†ï¼Œä½†è¿™ç§æƒ…å†µä¸åº”è¯¥å‘ç”Ÿ
            // å¹¶ä¸”ï¼Œæˆ‘ä»¬åªå¤„ç†å•èŠçš„æƒ…å†µï¼Œå› ä¸ºç¾¤èŠçš„æ—§è§£ææ–¹å¼å·²ç»è¯æ˜æ˜¯ä¸å¯é çš„
            if (!state.isGroupChat) {
                 const contact = state.contacts.find(c => c.id === state.currentChatId);
                 if(contact) {
                    processedMessages.push({ character: contact.name, content: aiResponseText });
                 }
            } else {
                // å¯¹äºç¾¤èŠï¼Œå¦‚æœJSONå¤±è´¥ï¼Œæˆ‘ä»¬æ˜¾ç¤ºä¸€æ¡é”™è¯¯ä¿¡æ¯ï¼Œè€Œä¸æ˜¯é”™è¯¯çš„è§£æç»“æœ
                throw new Error("ç¾¤èŠæ¨¡å¼ä¸‹AIæœªèƒ½è¿”å›æœ‰æ•ˆçš„JSONæ ¼å¼æ•°æ®ã€‚");
            }
        }


        // 4. å°†è§£æå‡ºçš„å¤šæ¡æ¶ˆæ¯é€ä¸€æ˜¾ç¤ºåˆ°å±å¹•ä¸Š
        for (const message of processedMessages) {
            // ä»ç¾¤æˆå‘˜æˆ–è”ç³»äººä¸­æ‰¾åˆ°å¯¹åº”çš„ä½œè€…ä¿¡æ¯
            const author = state.isGroupChat
                ? state.groups.find(g => g.id === state.currentChatId)?.members.find(m => m.name === message.character)
                : state.contacts.find(c => c.id === state.currentChatId);

            const authorId = author ? author.id : 'unknown';

            const aiMessage = {
                role: 'assistant',
                content: message.content,
                authorId: authorId,
                authorName: message.character,
                timestamp: Date.now()
            };

            state.chatHistory[state.currentChatId].push(aiMessage);
            addMessageToUI(aiMessage, state.chatHistory[state.currentChatId].length - 1);

            // æ¨¡æ‹ŸçœŸå®èŠå¤©çš„é—´éš”æ„Ÿ
            await new Promise(resolve => setTimeout(resolve, Math.random() * 800 + 300));
        }

        saveState('chatHistory');

    } catch (error) {
        removeTypingIndicator();
        console.error("An error occurred in handleSendMessage:", error);
        const errorMsg = {role: 'assistant', content: `âŒ é”™è¯¯: ${error.message}`, authorId: 'system', timestamp: Date.now()};
        addMessageToUI(errorMsg, -1);
    }
}
    
         function handleSavePromptSettings() {
    state.promptSettings = {
        main: mainPromptInput.value.trim(),
        single: singleChatPromptInput.value.trim(),
        group: groupChatPromptInput.value.trim(),
        group_online: document.getElementById('group-chat-prompt-online').value.trim(),
        group_offline: document.getElementById('group-chat-prompt-offline').value.trim(),
        summary: summaryPromptInput.value.trim(),
        jailbreak: jailbreakPromptInput.value.trim(),
        weibo: weiboPromptInput.value.trim(),
        // å…³é”®çš„ä¿®æ­£å°±åœ¨è¿™é‡Œï¼æˆ‘ä»¬æŠŠå…³æ³¨é¡µçš„æŒ‡å—ä¹ŸåŠ è¿›å»
        weibo_follow: document.getElementById('weibo-follow-prompt').value.trim()
    };
    saveState('promptSettings');
    promptSettingsModal.classList.add('hidden');
    showToast('æç¤ºè¯è®¾ç½®å·²ä¿å­˜');
}

    function handleClearApiSettings() {
        if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰APIæœåŠ¡è®¾ç½®å—ï¼Ÿç›¸å…³çš„å·²ç¼“å­˜æ¨¡å‹åˆ—è¡¨ä¹Ÿä¼šè¢«ä¸€åŒæ¸…é™¤ã€‚')) {
            state.apiSettings = { ...initialApiSettings };
            state.availableModels = { openai: [], gemini: [], claude: [] };
            saveState('apiSettings');
            saveState('availableModels');
            populateApiSettingsInputs();
            showToast('APIæœåŠ¡è®¾ç½®åŠç¼“å­˜å·²æ¸…é™¤');
        }
    }

    function handleProviderChange(fetch = true) {
        const provider = providerSelect.value;
        const defaults = {
            openai: { url: 'https://api.openai.com/v1', placeholder: 'e.g. https://api.openai.com/v1'},
            gemini: { url: 'https://generativelanguage.googleapis.com/v1beta', placeholder: 'e.g. https://generativelanguage.googleapis.com/v1beta' },
            claude: { url: 'https://api.anthropic.com/v1', placeholder: 'e.g. https://api.anthropic.com/v1' }
        };
        baseUrlInput.placeholder = defaults[provider]?.placeholder || '';
        if (fetch && (!state.apiSettings.baseUrl || state.apiSettings.baseUrl === defaults[state.apiSettings.provider]?.url)) {
            baseUrlInput.value = defaults[provider]?.url || '';
        }
        updateModelOptions();
    }

    async function handleRefreshModels() {
        refreshModelsBtn.disabled = true;
        testConnectionBtn.disabled = true;
        const provider = providerSelect.value,
              apiKey = apiKeyInput.value.trim(),
              baseUrl = baseUrlInput.value.trim();
        if (!apiKey || !baseUrl) {
            showToast('è¯·å…ˆè¾“å…¥ Base URL å’Œ API Key', 'error');
            refreshModelsBtn.disabled = false;
            testConnectionBtn.disabled = false;
            return;
        }
        showToast('æ­£åœ¨æ‹‰å–æ¨¡å‹åˆ—è¡¨...');
        try {
            const models = await fetchModels(provider, baseUrl, apiKey);
            state.availableModels[provider] = models;
            saveState('availableModels');
            updateModelOptions();
            showToast(`æˆåŠŸè·å– ${models.length} ä¸ªæ¨¡å‹`);
            modelSelect.disabled = false;
            toggleModelLockBtn.textContent = 'ğŸ”“';
            resetConnectionStatus();
        } catch (error) {
            console.error('Failed to fetch models:', error);
            showToast(`è·å–æ¨¡å‹å¤±è´¥: ${error.message}`, 'error');
        } finally {
            refreshModelsBtn.disabled = false;
            testConnectionBtn.disabled = false;
        }
    }

    function getSanitizedOpenAIBase(baseUrl) {
        return baseUrl.trim().replace(/\/+$/, '');
    }

    async function fetchModels(provider, baseUrl, apiKey) {
        const headers = { 'Content-Type': 'application/json' };
        let url, options;
        switch(provider) {
            case 'openai':
                headers['Authorization'] = `Bearer ${apiKey}`;
                url = `${getSanitizedOpenAIBase(baseUrl)}/models`;
                options = { method: 'GET', headers };
                break;
            case 'gemini':
                url = `${baseUrl}/models?key=${apiKey}`;
                options = { method: 'GET', headers };
                break;
            case 'claude':
                headers['x-api-key'] = apiKey;
                headers['anthropic-version'] = '2023-06-01';
                url = `${baseUrl}/models`;
                options = { method: 'GET', headers };
                break;
            default:
                throw new Error('ä¸æ”¯æŒçš„æä¾›å•†');
        }
        const response = await fetch(url, options);
        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: { message: `HTTP ${response.status}` } }));
            throw new Error(errorData.error?.message || `APIè¯·æ±‚å¤±è´¥`);
        }
        const data = await response.json();
        switch(provider) {
            case 'openai':
                return (data.data || []).map(m => ({ id: m.id, name: m.id })).sort((a,b) => a.name.localeCompare(b.name));
            case 'gemini':
                return (data.models || []).map(m => ({ id: m.name, name: m.displayName || m.name })).sort((a,b) => a.name.localeCompare(b.name));
            case 'claude':
                return (data.data || []).map(m => ({ id: m.id, name: m.name || m.id })).sort((a,b) => a.name.localeCompare(b.name));
            default:
                return [];
        }
    }

    function openGroupCreator() {
        groupMembersSelection.innerHTML = state.contacts.map(c =>
            `<label class="flex items-center p-2 rounded-lg hover:bg-gray-100 cursor-pointer">
                <input type="checkbox" class="w-5 h-5 mr-3" value="${c.id}">
                <span>${c.name}</span>
            </label>`
        ).join('');
        groupCreatorModal.classList.remove('hidden');
    }

    function handleCreateGroup() {
        const name = groupNameInput.value.trim();
        if (!name) return showToast('è¯·è¾“å…¥ç¾¤èŠåç§°', 'error');

        const selectedCheckboxes = Array.from(groupMembersSelection.querySelectorAll('input:checked'));
        if (selectedCheckboxes.length < 1) return showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç¾¤æˆå‘˜', 'error');

        const selectedMemberIds = selectedCheckboxes.map(cb => Number(cb.value));
        const memberObjects = state.contacts.filter(c => selectedMemberIds.includes(c.id));

        const newGroup = {
            id: Date.now(),
            name,
            members: memberObjects
        };

        state.groups.push(newGroup);
        saveState('groups');
        groupCreatorModal.classList.add('hidden');
        renderWechatContactList();
        showToast('ç¾¤èŠå·²åˆ›å»º');
    }

    function openSummaryModal() {
        const chatHistory = state.chatHistory[state.currentChatId] || [];
        totalMessagesCount.textContent = chatHistory.length;
        summaryStartIndexInput.max = chatHistory.length;
        summaryEndIndexInput.max = chatHistory.length;
        summaryStartIndexInput.value = 1;
        summaryEndIndexInput.value = chatHistory.length;
        summaryModal.classList.remove('hidden');
    }

    async function handleGenerateSummary() {
        const startIndex = parseInt(summaryStartIndexInput.value, 10) - 1;
        const endIndex = parseInt(summaryEndIndexInput.value, 10);
        const chatHistory = state.chatHistory[state.currentChatId] || [];
        if (startIndex < 0 || endIndex > chatHistory.length || startIndex >= endIndex) {
            return showToast('èµ·å§‹æˆ–ç»“æŸæ¡æ•°æ— æ•ˆ', 'error');
        }
        const historyToSummarize = chatHistory.slice(startIndex, endIndex);
        const chatTarget = state.isGroupChat ? state.groups.find(g => g.id === state.currentChatId) : state.contacts.find(c => c.id === state.currentChatId);

        showToast('æ­£åœ¨ç”Ÿæˆæ‘˜è¦...');
        summaryModal.classList.add('hidden');

        try {
            const summaryContent = await fetchAIResponse('summary', {
                chatHistory: historyToSummarize,
                charName: chatTarget.name,
            });
            const newEntry = {
                id: Date.now(),
                title: `ä¸ ${chatTarget.name} çš„èŠå¤©æ‘˜è¦ (${startIndex + 1}-${endIndex})`,
                category: state.isGroupChat ? 'ç¾¤èŠ' : 'ç§èŠ',
                content: summaryContent
            };
            state.worldbook.push(newEntry);
            saveState('worldbook');
            showToast('æ‘˜è¦å·²ç”Ÿæˆå¹¶å­˜å…¥ä¸–ç•Œä¹¦');
            renderWorldbook();
        } catch (error) {
            showToast(`ç”Ÿæˆæ‘˜è¦å¤±è´¥: ${error.message}`, 'error');
        }
    }

    function setWorldbookCategory(category) {
        state.currentWorldbookCategory = category;
        document.querySelectorAll('.category-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.category === category);
        });
        renderWorldbook();
    }

    function handleAddCategory() {
        const name = newCategoryNameInput.value.trim();
        if (!name) return showToast('è¯·è¾“å…¥åˆ†ç±»åç§°', 'error');
        if (state.worldbookCategories.includes(name)) return showToast('è¯¥åˆ†ç±»å·²å­˜åœ¨', 'error');
        state.worldbookCategories.push(name);
        saveState('worldbookCategories');
        const newTab = document.createElement('button');
        newTab.className = 'category-tab px-3 py-1 rounded-full text-sm whitespace-nowrap';
        newTab.dataset.category = name;
        newTab.textContent = name;
        addCategoryBtn.parentNode.insertBefore(newTab, addCategoryBtn);
        addCategoryModal.classList.add('hidden');
        newCategoryNameInput.value = '';
        showToast('åˆ†ç±»å·²æ·»åŠ ');
    }

    function renderWorldbook() {
        if (!worldbookContent) return;
        let filteredEntries = state.worldbook;
        if (state.currentWorldbookCategory !== 'all') {
            filteredEntries = state.worldbook.filter(entry => entry.category === state.currentWorldbookCategory);
        }
        worldbookContent.innerHTML = filteredEntries.length === 0 ?
            '<p class="text-center text-gray-500 mt-8">ä¸–ç•Œä¹¦æ˜¯ç©ºçš„ã€‚</p>' :
            filteredEntries.map(entry => `
                <div class="worldbook-entry bg-white rounded-lg shadow p-4 mb-4 relative ${state.selectedWorldbookEntries.has(entry.id) ? 'selected' : ''}" data-entry-id="${entry.id}">
                    <input type="checkbox" class="worldbook-delete-checkbox ${state.worldbookDeleteMode ? '' : 'hidden'} absolute top-2 right-2 w-5 h-5" data-entry-id="${entry.id}">
                    <h3 class="font-bold text-lg">${entry.title}</h3>
                    <p class="text-sm text-gray-500">${entry.category}</p>
                    <div class="text-base text-gray-700 mt-2 line-clamp-2">${entry.content.substring(0, 100)}${entry.content.length > 100 ? '...' : ''}</div>
                </div>
            `).join('');
        document.querySelectorAll('.worldbook-entry').forEach(entry => {
            entry.addEventListener('click', (e) => {
                if (!state.worldbookDeleteMode) {
                    const entryId = parseInt(entry.dataset.entryId);
                    openWorldbookEntryModal(entryId);
                }
            });
        });
    }

    function openWorldbookEntryModal(entryId) {
        const entry = state.worldbook.find(e => e.id === entryId);
        if (!entry) return;
        currentViewingEntryId = entryId;
        entryModalTitle.textContent = entry.title;
        entryModalCategory.textContent = entry.category;
        entryModalContent.textContent = entry.content;
        if (state.currentChatId) {
            bindEntryBtn.style.display = 'block';
            const isBound = state.boundWorldbookEntries[state.currentChatId]?.includes(entryId);
            bindEntryBtn.textContent = isBound ? 'å·²ç»‘å®š' : 'ç»‘å®šåˆ°å½“å‰èŠå¤©';
            bindEntryBtn.disabled = isBound;
        } else {
            bindEntryBtn.style.display = 'none';
        }
        worldbookEntryModal.classList.remove('hidden');
    }

    function handleBindEntry() {
        if (!state.currentChatId || !currentViewingEntryId) return;
        if (!state.boundWorldbookEntries[state.currentChatId]) {
            state.boundWorldbookEntries[state.currentChatId] = [];
        }
        if (!state.boundWorldbookEntries[state.currentChatId].includes(currentViewingEntryId)) {
            state.boundWorldbookEntries[state.currentChatId].push(currentViewingEntryId);
            saveState('boundWorldbookEntries');
            bindEntryBtn.textContent = 'å·²ç»‘å®š';
            bindEntryBtn.disabled = true;
            showToast('ä¸–ç•Œä¹¦æ¡ç›®å·²ç»‘å®šåˆ°å½“å‰èŠå¤©');
        }
    }

    function openWorldbookSelectionModal() {
        worldbookSelectionList.innerHTML = state.worldbook.length === 0 ?
            '<p class="text-center text-gray-500 py-4">ä¸–ç•Œä¹¦æ˜¯ç©ºçš„ã€‚</p>' :
            state.worldbook.map(entry => `
                <label class="flex items-center p-3 border-b cursor-pointer hover:bg-gray-50">
                    <input type="checkbox" class="w-5 h-5 mr-3 worldbook-selection-checkbox" value="${entry.id}">
                    <div>
                        <h4 class="font-semibold">${entry.title}</h4>
                        <p class="text-sm text-gray-500">${entry.category}</p>
                        <p class="text-sm text-gray-700 line-clamp-2">${entry.content.substring(0, 80)}${entry.content.length > 80 ? '...' : ''}</p>
                    </div>
                </label>
            `).join('');
        state.selectedWorldbookEntriesForBinding.clear();
        worldbookSelectionModal.classList.remove('hidden');
    }

    function handleConfirmWorldbookSelection() {
        if (!state.currentChatId) return showToast('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªèŠå¤©', 'error');
        const selectedCheckboxes = document.querySelectorAll('.worldbook-selection-checkbox:checked');
        if (selectedCheckboxes.length === 0) return showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªä¸–ç•Œä¹¦æ¡ç›®', 'error');
        if (!state.boundWorldbookEntries[state.currentChatId]) {
            state.boundWorldbookEntries[state.currentChatId] = [];
        }
        selectedCheckboxes.forEach(checkbox => {
            const entryId = parseInt(checkbox.value);
            if (!state.boundWorldbookEntries[state.currentChatId].includes(entryId)) {
                state.boundWorldbookEntries[state.currentChatId].push(entryId);
            }
        });
        saveState('boundWorldbookEntries');
        worldbookSelectionModal.classList.add('hidden');
        showToast(`å·²ç»‘å®š ${selectedCheckboxes.length} ä¸ªä¸–ç•Œä¹¦æ¡ç›®`);
        if (chatSidebar.classList.contains('active')) {
            loadSidebarContent();
        }
    }

    function openAvatarUploadModal(target) {
        state.avatarUploadTarget = target;
        if (target === 'user') {
            avatarPreview.src = state.userProfile.avatar || 'https://i.postimg.cc/Fs8RPSdF/image.png';
        } else if (target === 'contact-editor') {
            avatarPreview.src = contactAvatarInput.value || 'https://i.postimg.cc/Fs8RPSdF/image.png';
        } else {
            const contactId = parseInt(target);
            let targetContact = state.contacts.find(c => c.id === contactId);
            if (!targetContact) {
                for (let group of state.groups) {
                    targetContact = group.members.find(m => m.id === contactId);
                    if (targetContact) break;
                }
            }
            if (targetContact) {
                avatarPreview.src = targetContact.avatar || 'https://i.postimg.cc/Fs8RPSdF/image.png';
            } else {
                avatarPreview.src = 'https://i.postimg.cc/Fs8RPSdF/image.png';
            }
        }
        avatarUploadModal.classList.remove('hidden');
    }

    function handleAvatarUpload(e) {
        const file = e.target.files[0];
        if (!file || !file.type.startsWith('image/')) return showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
        const reader = new FileReader();
        reader.onload = (event) => avatarPreview.src = event.target.result;
        reader.readAsDataURL(file);
    }

    function handleSaveAvatar() {
        const newAvatarUrl = avatarPreview.src;
        if (state.avatarUploadTarget === 'user') {
            state.userProfile.avatar = newAvatarUrl;
            saveState('userProfile');
            showToast('ä¸ªäººå¤´åƒå·²æ›´æ–°');
        } else if (state.avatarUploadTarget === 'contact-editor') {
            contactAvatarInput.value = newAvatarUrl;
            document.getElementById('contact-avatar-preview').src = newAvatarUrl;
            showToast('å¤´åƒå·²æ›´æ–°åˆ°è¡¨å•');
        } else {
            const contactId = parseInt(state.avatarUploadTarget);
            const contactIndex = state.contacts.findIndex(c => c.id === contactId);
            if (contactIndex > -1) {
                state.contacts[contactIndex].avatar = newAvatarUrl;
                saveState('contacts');
                if (state.chatHistory[contactId]) {
                    state.chatHistory[contactId].forEach(msg => {
                        if (msg.authorId === contactId) msg.avatar = newAvatarUrl;
                    });
                    saveState('chatHistory');
                }
                showToast('è”ç³»äººå¤´åƒå·²æ›´æ–°');
            } else {
                let updated = false;
                for (let group of state.groups) {
                    const memberIndex = group.members.findIndex(m => m.id === contactId);
                    if (memberIndex > -1) {
                        group.members[memberIndex].avatar = newAvatarUrl;
                        saveState('groups');
                        const groupChatId = group.id;
                        if (state.chatHistory[groupChatId]) {
                            state.chatHistory[groupChatId].forEach(msg => {
                                if (msg.authorId === contactId) msg.avatar = newAvatarUrl;
                            });
                            saveState('chatHistory');
                        }
                        showToast('ç¾¤èŠæˆå‘˜å¤´åƒå·²æ›´æ–°');
                        updated = true;
                        break;
                    }
                }
            }
        }
        avatarUploadModal.classList.add('hidden');
        if (state.currentChatId) {
            openChat(state.currentChatId, state.isGroupChat);
        }
        renderContactsList();
        renderWechatContactList();
    }

    function toggleWorldbookDeleteMode() {
        state.worldbookDeleteMode = !state.worldbookDeleteMode;
        worldbookDeleteModeToggle.textContent = state.worldbookDeleteMode ? 'å®Œæˆ' : 'ç®¡ç†';
        worldbookDeleteFooter.classList.toggle('hidden', !state.worldbookDeleteMode);
        document.querySelectorAll('.worldbook-delete-checkbox').forEach(cb => cb.classList.toggle('hidden', !state.worldbookDeleteMode));
        if (!state.worldbookDeleteMode) {
            state.selectedWorldbookEntries.clear();
            updateWorldbookDeleteButton();
        }
    }

    function handleWorldbookSelectAll() {
        const allCheckboxes = document.querySelectorAll('.worldbook-delete-checkbox');
        const allVisibleEntryIds = Array.from(document.querySelectorAll('.worldbook-entry')).map(el => Number(el.dataset.entryId));
        const allSelected = allVisibleEntryIds.every(id => state.selectedWorldbookEntries.has(id));
        allCheckboxes.forEach(cb => {
            const entryId = Number(cb.dataset.entryId);
            cb.checked = !allSelected;
            if (!allSelected) {
                state.selectedWorldbookEntries.add(entryId);
            } else {
                state.selectedWorldbookEntries.delete(entryId);
            }
        });
        updateWorldbookDeleteButton();
    }

    function handleWorldbookDelete() {
        if (state.selectedWorldbookEntries.size === 0) return;
        if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${state.selectedWorldbookEntries.size} æ¡ä¸–ç•Œä¹¦æ¡ç›®å—ï¼Ÿ`)) {
            state.worldbook = state.worldbook.filter(entry => !state.selectedWorldbookEntries.has(entry.id));
            Object.keys(state.boundWorldbookEntries).forEach(chatId => {
                state.boundWorldbookEntries[chatId] = state.boundWorldbookEntries[chatId].filter(
                    entryId => !state.selectedWorldbookEntries.has(entryId)
                );
            });
            saveState('worldbook');
            saveState('boundWorldbookEntries');
            renderWorldbook();
            toggleWorldbookDeleteMode();
        }
    }

    function updateWorldbookDeleteButton() {
        const count = state.selectedWorldbookEntries.size;
        worldbookExecuteDeleteBtn.disabled = count === 0;
        worldbookExecuteDeleteBtn.textContent = count > 0 ? `åˆ é™¤ (${count})` : 'åˆ é™¤';
    }

    worldbookContent.addEventListener('change', (e) => {
        if (e.target.classList.contains('worldbook-delete-checkbox')) {
            const entryId = Number(e.target.dataset.entryId);
            if (e.target.checked) {
                state.selectedWorldbookEntries.add(entryId);
            } else {
                state.selectedWorldbookEntries.delete(entryId);
            }
            updateWorldbookDeleteButton();
        }
    });

    function openChatSidebar() {
        chatSidebar.classList.add('active');
        loadSidebarContent();
    }

    function closeChatSidebar() {
        chatSidebar.classList.remove('active');
    }

    function loadSidebarContent() {
        if (!state.currentChatId) return;
        let chatTarget = state.isGroupChat ? state.groups.find(g => g.id === state.currentChatId) : state.contacts.find(c => c.id === state.currentChatId);
        if (!chatTarget) return;

        const chatSettingsHtml = `<div class="sidebar-section"><h3 class="font-bold mb-3">èŠå¤©è®¾ç½®</h3><div class="space-y-2"><div class="flex justify-between items-center p-2 rounded-lg bg-gray-50"><span>èŠå¤©æ¨¡å¼</span><div class="flex items-center"><span class="chat-mode-indicator ${state.chatMode === 'online' ? 'online-mode' : 'offline-mode'} mr-2">${state.chatMode === 'online' ? 'çº¿ä¸Šæ¨¡å¼' : 'çº¿ä¸‹æ¨¡å¼'}</span><button id="toggle-chat-mode-btn" class="text-blue-500 text-sm font-medium">åˆ‡æ¢</button></div></div></div></div>`;
        const worldbookBindingHtml = `<div class="sidebar-section"><div class="flex justify-between items-center mb-3"><h3 class="font-bold">ç»‘å®šçš„ä¸–ç•Œä¹¦</h3><button id="add-worldbook-binding-btn" class="text-blue-500 text-sm font-medium">æ·»åŠ /ç®¡ç†</button></div><div id="bound-entries-list" class="space-y-2">${renderBoundEntries()}</div></div>`;

        if (state.isGroupChat) {
            sidebarContent.innerHTML = `<div class="space-y-4"><div class="sidebar-section text-center"><img id="group-avatar" src="${chatTarget.avatar || `https://avatar.vercel.sh/group${chatTarget.id}`}" alt="${chatTarget.name}" class="w-20 h-20 rounded-full mx-auto mb-3 object-cover"><input id="group-name-input" type="text" value="${chatTarget.name}" class="text-lg font-bold text-center bg-transparent border-b border-gray-300 focus:outline-none focus:border-blue-500 w-full mb-2"><button id="save-group-info" class="bg-blue-500 text-white px-3 py-1 rounded-lg text-sm">ä¿å­˜åç§°</button></div><div class="sidebar-section"><h3 class="font-bold mb-3">ç¾¤æˆå‘˜ (${chatTarget.members.length + 1})</h3><div id="group-members-list" class="space-y-2 max-h-48 overflow-y-auto">${[state.userProfile, ...chatTarget.members].map(member => `<div class="member-item"><img src="${member.avatar || 'https://i.postimg.cc/Fs8RPSdF/image.png'}" alt="${member.name}" class="member-avatar"><div class="member-info"><div class="member-name">${member.name}${member.id === 'user' ? ' (ä½ )' : ''}</div><div class="member-role">${member.id === 'user' ? 'ç¾¤ä¸»' : 'æˆå‘˜'}</div></div>${member.id !== 'user' ? `<button class="remove-member-btn" data-member-id="${member.id}">ç§»é™¤</button>` : ''}</div>`).join('')}</div><button id="add-member-btn" class="w-full mt-3 bg-green-100 text-green-600 py-2 rounded-lg text-sm font-medium">æ·»åŠ æˆå‘˜</button></div>${chatSettingsHtml}${worldbookBindingHtml}</div>`;
            document.getElementById('save-group-info').addEventListener('click', saveGroupInfo);
            document.getElementById('add-member-btn').addEventListener('click', openAddMemberModal);
            document.querySelectorAll('.remove-member-btn').forEach(btn => btn.addEventListener('click', (e) => removeMemberFromGroup(e.target.dataset.memberId)));
        } else {
            sidebarContent.innerHTML = `<div class="space-y-4"><div class="sidebar-section text-center"><img src="${chatTarget.avatar || 'https://i.postimg.cc/Fs8RPSdF/image.png'}" alt="${chatTarget.name}" class="w-20 h-20 rounded-full mx-auto mb-3 object-cover"><p class="text-lg font-bold">${chatTarget.name}</p></div><div class="sidebar-section"><h3 class="font-bold mb-3">è¯¦ç»†ä¿¡æ¯</h3><div class="space-y-2 text-sm"><div class="flex justify-between p-2 rounded-lg bg-gray-50"><span>å§“å:</span> <span>${chatTarget.name}</span></div><div class="flex justify-between p-2 rounded-lg bg-gray-50"><span>å¹´é¾„:</span> <span>${chatTarget.age || 'æœªè®¾ç½®'}</span></div><div class="flex justify-between p-2 rounded-lg bg-gray-50"><span>æ€§åˆ«:</span> <span>${chatTarget.gender || 'æœªè®¾ç½®'}</span></div></div><button id="edit-contact-info-btn" class="w-full mt-3 bg-blue-100 text-blue-600 py-2 rounded-lg text-sm font-medium">ç¼–è¾‘èµ„æ–™</button></div>${chatSettingsHtml}${worldbookBindingHtml}<div class="sidebar-section"><button id="delete-chat-btn" class="w-full bg-red-100 text-red-600 py-2 rounded-lg font-medium">åˆ é™¤æ­¤è”ç³»äºº</button></div></div>`;
            document.getElementById('delete-chat-btn').addEventListener('click', deleteChat);
            document.getElementById('edit-contact-info-btn').addEventListener('click', () => openContactEditor(state.currentChatId));
        }
        document.getElementById('toggle-chat-mode-btn').addEventListener('click', toggleChatMode);
        document.getElementById('add-worldbook-binding-btn').addEventListener('click', openWorldbookSelectionModal);
        document.querySelectorAll('.unbind-btn').forEach(btn => btn.addEventListener('click', (e) => unbindWorldbookEntry(parseInt(e.target.dataset.entryId))));
    }

    function toggleChatMode() {
        state.chatMode = state.chatMode === 'online' ? 'offline' : 'online';
        saveState('chatMode');
        showToast(`æ¨¡å¼å·²åˆ‡æ¢ä¸º: ${state.chatMode === 'online' ? 'çº¿ä¸Šæ¨¡å¼' : 'çº¿ä¸‹æ¨¡å¼'}`);
        loadSidebarContent();
    }

    function renderBoundEntries() {
        if (!state.currentChatId || !state.boundWorldbookEntries[state.currentChatId] || state.boundWorldbookEntries[state.currentChatId].length === 0) {
            return '<p class="text-gray-500 text-center py-3">æš‚æ— ç»‘å®šçš„ä¸–ç•Œä¹¦æ¡ç›®</p>';
        }
        return state.boundWorldbookEntries[state.currentChatId].map(entryId => {
            const entry = state.worldbook.find(w => w.id === entryId);
            if (!entry) return '';
            return `<div class="bound-entry-item"><div class="bound-entry-title">${entry.title}</div><div class="bound-entry-category">${entry.category}</div><button class="unbind-btn" data-entry-id="${entryId}">è§£é™¤ç»‘å®š</button></div>`;
        }).join('');
    }
    // åœ¨ loadSidebarContent å‡½æ•°çš„æœ«å°¾æ·»åŠ 
document.querySelectorAll('.unbind-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
        const entryId = parseInt(e.target.dataset.entryId);
        unbindWorldbookEntry(entryId);
    });
});


    function unbindWorldbookEntry(entryId) {
        if (!state.currentChatId || !state.boundWorldbookEntries[state.currentChatId]) return;
        state.boundWorldbookEntries[state.currentChatId] = state.boundWorldbookEntries[state.currentChatId].filter(id => id !== entryId);
        saveState('boundWorldbookEntries');
        loadSidebarContent();
        showToast('å·²è§£é™¤ç»‘å®š');
    }

    function saveGroupInfo() {
        const groupName = document.getElementById('group-name-input').value.trim();
        const groupAvatar = document.getElementById('group-avatar').src;
        if (!groupName) return showToast('ç¾¤èŠåç§°ä¸èƒ½ä¸ºç©º', 'error');
        const groupIndex = state.groups.findIndex(g => g.id === state.currentChatId);
        if (groupIndex > -1) {
            state.groups[groupIndex].name = groupName;
            state.groups[groupIndex].avatar = groupAvatar;
            saveState('groups');
            chatContactName.textContent = groupName;
            showToast('ç¾¤èŠä¿¡æ¯å·²æ›´æ–°');
            renderWechatContactList();
        }
    }

    function openAddMemberModal() {
        const modalContent = `<div class="p-4 space-y-4"><h2 class="text-xl font-bold text-center">æ·»åŠ æˆå‘˜</h2><div class="max-h-60 overflow-y-auto bg-white rounded-lg p-2 space-y-1">${state.contacts.map(contact => `<label class="flex items-center p-2 rounded-lg hover:bg-gray-100 cursor-pointer"><input type="checkbox" class="w-5 h-5 mr-3 member-checkbox" value="${contact.id}"><img src="${contact.avatar || 'https://i.postimg.cc/Fs8RPSdF/image.png'}" alt="${contact.name}" class="w-8 h-8 rounded-full mr-2 object-cover"><span>${contact.name}</span></label>`).join('')}</div><div class="grid grid-cols-2 gap-4"><button id="cancel-add-member" class="w-full bg-gray-200 text-gray-800 font-bold py-2 rounded-lg">å–æ¶ˆ</button><button id="confirm-add-member" class="w-full bg-blue-500 text-white font-bold py-2 rounded-lg">æ·»åŠ </button></div></div>`;
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black/40 backdrop-blur-sm z-40 flex items-center justify-center';
        modal.innerHTML = modalContent;
        document.body.appendChild(modal);
        document.getElementById('cancel-add-member').addEventListener('click', () => document.body.removeChild(modal));
        document.getElementById('confirm-add-member').addEventListener('click', () => {
            const selectedMembers = Array.from(document.querySelectorAll('.member-checkbox:checked')).map(cb => Number(cb.value));
            addMembersToGroup(selectedMembers);
            document.body.removeChild(modal);
        });
    }

    function addMembersToGroup(memberIds) {
        const groupIndex = state.groups.findIndex(g => g.id === state.currentChatId);
        if (groupIndex === -1) return;
        const currentGroup = state.groups[groupIndex];
        const existingMemberIds = currentGroup.members.map(m => m.id);
        memberIds.forEach(id => {
            if (!existingMemberIds.includes(id)) {
                const contact = state.contacts.find(c => c.id === id);
                if (contact) currentGroup.members.push(contact);
            }
        });
        saveState('groups');
        loadSidebarContent();
        showToast('æˆå‘˜å·²æ·»åŠ ');
    }

    function removeMemberFromGroup(memberId) {
        const groupIndex = state.groups.findIndex(g => g.id === state.currentChatId);
        if (groupIndex === -1) return;
        const currentGroup = state.groups[groupIndex];
        currentGroup.members = currentGroup.members.filter(m => m.id != memberId);
        saveState('groups');
        loadSidebarContent();
        showToast('æˆå‘˜å·²ç§»é™¤');
    }

    function deleteChat() {
        if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤èŠå¤©å—ï¼Ÿæ‰€æœ‰èŠå¤©è®°å½•éƒ½å°†è¢«åˆ é™¤ã€‚')) {
            if (state.isGroupChat) {
                state.groups = state.groups.filter(g => g.id !== state.currentChatId);
                saveState('groups');
            } else {
                state.contacts = state.contacts.filter(c => c.id !== state.currentChatId);
                saveState('contacts');
            }
            delete state.chatHistory[state.currentChatId];
            delete state.boundWorldbookEntries[state.currentChatId];
            saveState('chatHistory');
            saveState('boundWorldbookEntries');
            showToast('èŠå¤©å·²åˆ é™¤');
            closeChatSidebar();
            showWechatListView();
        }
    }

    function handleExportData() {
        const allData = {};
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('nova_')) {
                allData[key] = localStorage.getItem(key);
            }
        }
        if (Object.keys(allData).length === 0) return showToast('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®', 'error');
        const jsonString = JSON.stringify(allData, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
        a.href = url;
        a.download = `NovaOS_Backup_${timestamp}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('æ•°æ®å·²å¯¼å‡º');
    }

    function handleImportData(event) {
        const file = event.target.files[0];
        if (!file || !file.name.endsWith('.json')) return showToast('è¯·é€‰æ‹©ä¸€ä¸ª .json å¤‡ä»½æ–‡ä»¶', 'error');
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if (typeof importedData !== 'object' || importedData === null) throw new Error('æ— æ•ˆçš„æ•°æ®æ ¼å¼');
                if (!Object.keys(importedData).some(k => k.startsWith('nova_'))) throw new Error('æ–‡ä»¶å†…å®¹ä¼¼ä¹ä¸æ˜¯æœ‰æ•ˆçš„å¤‡ä»½');
                if (confirm('è¿™å°†è¦†ç›–æ‰€æœ‰ç°æœ‰æ•°æ®ï¼Œç¡®å®šè¦å¯¼å…¥å—?')) {
                    Object.keys(localStorage).filter(key => key.startsWith('nova_')).forEach(key => localStorage.removeItem(key));
                    for (const key in importedData) {
                        if (key.startsWith('nova_')) localStorage.setItem(key, importedData[key]);
                    }
                    showToast('æ•°æ®å¯¼å…¥æˆåŠŸï¼Œè¯·åˆ·æ–°é¡µé¢');
                    setTimeout(() => location.reload(), 1500);
                }
            } catch (error) {
                showToast(`å¯¼å…¥å¤±è´¥: ${error.message}`, 'error');
            } finally {
                importFileInput.value = '';
            }
        };
        reader.readAsText(file);
    }

    // ==================== å¾®åšåŠŸèƒ½ ====================
    let weiboData = {
        currentAccount: 'main',
        accounts: {
            main: { name: 'æˆ‘çš„æ˜µç§°', avatar: 'https://via.placeholder.com/80', signature: '', posts: [], likes: 0, fans: 0 }
        },
        followedAIs: [],
        recommendPosts: [],
        hotTopics: [
            { title: '#ä»Šæ—¥çƒ­ç‚¹#', heat: '1234ä¸‡' },
            { title: '#å¨±ä¹å…«å¦#', heat: '890ä¸‡' },
            { title: '#ç§‘æŠ€å‰æ²¿#', heat: '567ä¸‡' }
        ],
        currentPostDetail: null
    };

    function openWeiboApp() {
        document.getElementById('weibo-app').classList.remove('hidden');
        loadWeiboData();
        refreshRecommendPosts();
    }

    function loadWeiboData() {
        const saved = localStorage.getItem('nova_weiboData');
        if (saved) weiboData = JSON.parse(saved);
        updateWeiboProfile();
        loadFollowedAIs();
    }

    function saveWeiboData() {
        localStorage.setItem('nova_weiboData', JSON.stringify(weiboData));
    }

    function updateWeiboProfile() {
        const account = weiboData.accounts[weiboData.currentAccount];
        document.getElementById('weibo-profile-avatar').src = account.avatar;
        document.getElementById('weibo-profile-name').value = account.name;
        document.getElementById('weibo-profile-signature').value = account.signature;
        document.getElementById('weibo-post-count').textContent = account.posts.length;
        document.getElementById('weibo-like-count').textContent = account.likes;
        document.getElementById('weibo-fans-count').textContent = account.fans;
        renderMyPosts();
    }

            async function refreshRecommendPosts() {
        const container = document.getElementById('weibo-recommend-content');
        container.innerHTML = '<div class="text-center py-8 text-gray-500">æ­£åœ¨åˆ·æ–°...</div>';
        try {
            // æ¨èé¡µçš„AIåˆ—è¡¨åº”è¯¥æ˜¯æ‰€æœ‰é€šè®¯å½•é‡Œçš„è”ç³»äººï¼Œè®©ä¸–ç•Œæ›´ä¸°å¯Œ
            const all_ai_list = state.contacts.map(c => ({
                id: c.id,
                name: c.name,
                persona: c.persona,
                is_public_figure: Math.random() > 0.5
            }));

            let responseText = await fetchAIResponse('weibo', { followed_ai_list: all_ai_list });

            const jsonMatch = responseText.match(/```json\s*([\s\S]*?)\s*```/);
            if (jsonMatch && jsonMatch[1]) {
                responseText = jsonMatch[1];
            }

            const posts = JSON.parse(responseText);
            weiboData.recommendPosts = posts.map(p => ({ ...p, id: Date.now() + Math.random(), commentList: [] }));
            renderRecommendPosts();
        } catch (error) {
            console.error("å¾®åšåˆ·æ–°å¤±è´¥:", error);
            container.innerHTML = `<div class="text-center py-8 text-red-500">åˆ·æ–°å¤±è´¥: ${error.message}</div>`;
        }
    }
 
    function renderRecommendPosts() {
        const container = document.getElementById('weibo-recommend-content');
        container.innerHTML = '';
        weiboData.recommendPosts.forEach(post => {
            const postEl = createWeiboPostElement(post);
            container.appendChild(postEl);
        });
    }

    function createWeiboPostElement(post) {
    const div = document.createElement('div');
    div.className = 'bg-white rounded-lg p-4 shadow-sm';

    // åœ¨è¿™é‡ŒåŠ ä¸€æ­¥ï¼šæ ¹æ®ä½œè€…åæ‰¾åˆ°æ­£ç¡®çš„å¤´åƒ
    let authorAvatar = post.author.avatar; // é»˜è®¤ä½¿ç”¨AIè¿”å›çš„å¤´åƒ
    const contact = state.contacts.find(c => c.name === post.author.name);
    if (contact && contact.avatar) {
        authorAvatar = contact.avatar; // å¦‚æœåœ¨é€šè®¯å½•é‡Œæ‰¾åˆ°äº†ï¼Œå°±ç”¨é€šè®¯å½•é‡Œçš„å¤´åƒ
    }

    div.innerHTML = `
        <div class="flex items-start mb-3">
            <img src="${authorAvatar}" class="w-12 h-12 rounded-full mr-3 object-cover">
            <div class="flex-grow">
                <div class="font-bold">${post.author.name}</div>
                <div class="text-xs text-gray-500">${post.timestamp}</div>
            </div>
        </div>
        <div class="text-base mb-3 whitespace-pre-wrap">${post.content}</div>
        <div class="flex justify-around border-t pt-3 text-gray-600">
            <button class="weibo-like-btn flex items-center space-x-1" data-post-id="${post.id}"><span>ğŸ‘</span><span>${post.likes}</span></button>
            <button class="weibo-comment-btn flex items-center space-x-1" data-post-id="${post.id}"><span>ğŸ’¬</span><span>${post.comments}</span></button>
            <button class="weibo-repost-btn flex items-center space-x-1" data-post-id="${post.id}"><span>ğŸ”„</span><span>${post.reposts}</span></button>
        </div>
    `;
    div.addEventListener('click', (e) => {
        if (!e.target.closest('button')) openWeiboDetail(post);
    });
    return div;
}

    function openWeiboDetail(post) {
        weiboData.currentPostDetail = post;
        document.getElementById('weibo-main-view').classList.add('hidden');
        document.getElementById('weibo-detail-view').classList.remove('hidden');
        renderWeiboDetail();
    }

    function renderWeiboDetail() {
        const post = weiboData.currentPostDetail;
        const container = document.getElementById('weibo-detail-content');
        container.innerHTML = `
            <div class="flex items-start mb-4">
                <img src="${post.author.avatar}" class="w-12 h-12 rounded-full mr-3 object-cover">
                <div class="flex-grow">
                    <div class="font-bold">${post.author.name}</div>
                    <div class="text-xs text-gray-500">${post.timestamp}</div>
                </div>
            </div>
            <div class="text-base mb-4 whitespace-pre-wrap">${post.content}</div>
            <div class="flex justify-around border-y py-3 mb-4 text-gray-600">
                <button id="weibo-detail-like" class="flex items-center space-x-1"><span>ğŸ‘</span><span>${post.likes}</span></button>
                <button id="weibo-detail-comment" class="flex items-center space-x-1"><span>ğŸ’¬</span><span>${post.comments}</span></button>
                <button id="weibo-detail-repost" class="flex items-center space-x-1"><span>ğŸ”„</span><span>${post.reposts}</span></button>
            </div>
        `;
        document.getElementById('weibo-comment-count').textContent = post.commentList.length;
        renderComments();
        document.getElementById('weibo-detail-like').addEventListener('click', () => {
            post.likes++;
            renderWeiboDetail();
        });
    }

    function renderComments() {
        const post = weiboData.currentPostDetail;
        const container = document.getElementById('weibo-comments-list');
        container.innerHTML = post.commentList.length === 0 ? '<div class="text-center text-gray-400 py-4">æš‚æ— è¯„è®º</div>' : post.commentList.map(c => createCommentElement(c).outerHTML).join('');
    }

    function createCommentElement(comment, isReply = false) {
        const div = document.createElement('div');
        div.className = isReply ? 'ml-8 mt-2 p-2 bg-gray-50 rounded' : 'border-b pb-3';
        div.innerHTML = `<div class="flex items-start"><img src="${comment.avatar}" class="w-8 h-8 rounded-full mr-2 object-cover"><div class="flex-grow"><div class="font-bold text-sm">${comment.name}</div><div class="text-sm mt-1">${comment.content}</div><div class="flex items-center mt-1 text-xs text-gray-500"><span>${comment.time}</span><button class="ml-4 text-orange-500 weibo-reply-btn" data-comment-id="${comment.id}">å›å¤</button></div>${comment.replies ? `<div class="mt-2 space-y-2">${comment.replies.map(r => createCommentElement(r, true).outerHTML).join('')}</div>` : ''}</div></div>`;
        return div;
    }

    async function sendWeiboComment() {
        const input = document.getElementById('weibo-comment-input');
        const content = input.value.trim();
        if (!content) return;
        const post = weiboData.currentPostDetail;
        const account = weiboData.accounts[weiboData.currentAccount];
        const comment = { id: Date.now(), name: account.name, avatar: account.avatar, content: content, time: 'åˆšåˆš', replies: [] };
        post.commentList.push(comment);
        post.comments++;
        input.value = '';
        renderWeiboDetail();
    }

    async function generateMyWeiboContent() {
        const weiboPrompt = state.promptSettings.weibo;
        if (!state.apiSettings.connected) {
            showToast('AIæœåŠ¡æœªè¿æ¥', 'error');
            return null;
        }
        try {
            const response = await fetchAIResponse('weibo', { followed_ai_list: [{ id: 'user', name: 'æˆ‘', persona: 'å‘å¸–äºº', is_public_figure: false }] });
            const posts = JSON.parse(response);
            return posts[0]?.content || 'ä»Šå¤©å¤©æ°”ä¸é”™ã€‚';
        } catch (error) {
            console.error('ç”Ÿæˆå¾®åšå†…å®¹å¤±è´¥:', error);
            return null;
        }
    }

    async function publishWeibo() {
        const textarea = document.getElementById('weibo-post-textarea');
        let content = textarea.value.trim();
        if (!content) return showToast('è¯·è¾“å…¥å¾®åšå†…å®¹');
        const account = weiboData.accounts[weiboData.currentAccount];
        const post = { id: Date.now(), author: { name: account.name, avatar: account.avatar, isAI: false }, content, timestamp: 'åˆšåˆš', likes: 0, comments: 0, reposts: 0, commentList: [] };
        account.posts.unshift(post);
        document.getElementById('weibo-post-modal').classList.add('hidden');
        textarea.value = '';
        const fansChange = Math.floor(Math.random() * 10) - 3;
        account.fans = Math.max(0, account.fans + fansChange);
        saveWeiboData();
        renderMyPosts();
        setTimeout(() => {
            post.likes = Math.floor(Math.random() * 50);
            post.comments = Math.floor(Math.random() * 10);
            saveWeiboData();
            renderMyPosts();
        }, 2000);
    }

    function renderMyPosts() {
        const account = weiboData.accounts[weiboData.currentAccount];
        const container = document.getElementById('weibo-my-posts');
        container.innerHTML = account.posts.length === 0 ? '<div class="text-center py-8 text-gray-400">è¿˜æ²¡æœ‰å‘å¸ƒå¾®åš</div>' : account.posts.map(p => createWeiboPostElement(p).outerHTML).join('');
    }

    function addWeiboAccount() {
        const name = prompt('è¾“å…¥å°å·æ˜µç§°ï¼š');
        if (!name) return;
        const accountId = 'account_' + Date.now();
        weiboData.accounts[accountId] = { name, avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${accountId}`, signature: '', posts: [], likes: 0, fans: 0 };
        weiboData.currentAccount = accountId;
        saveWeiboData();
        updateWeiboProfile();
        renderAccountList();
        document.getElementById('weibo-account-modal').classList.add('hidden');
    }

    function renderAccountList() {
        const container = document.getElementById('weibo-account-list');
        container.innerHTML = Object.keys(weiboData.accounts).map(accountId => {
            const account = weiboData.accounts[accountId];
            return `<div class="flex items-center justify-between p-3 border rounded-lg ${weiboData.currentAccount === accountId ? 'bg-orange-50 border-orange-500' : ''}"><div class="flex items-center"><img src="${account.avatar}" class="w-10 h-10 rounded-full mr-3 object-cover"><div><div class="font-bold">${account.name}</div><div class="text-xs text-gray-500">ç²‰ä¸ ${account.fans}</div></div></div>${weiboData.currentAccount !== accountId ? `<button class="weibo-switch-account-btn text-orange-500 text-sm" data-account-id="${accountId}">åˆ‡æ¢</button>` : '<span class="text-orange-500 text-sm">å½“å‰</span>'}</div>`;
        }).join('');
    }

    function switchWeiboAccount(accountId) {
        weiboData.currentAccount = accountId;
        saveWeiboData();
        updateWeiboProfile();
        document.getElementById('weibo-account-modal').classList.add('hidden');
    }

    function uploadWeiboAvatar() {
        state.avatarUploadTarget = `weibo_${weiboData.currentAccount}`;
        avatarUploadModal.classList.remove('hidden');
        avatarPreview.src = weiboData.accounts[weiboData.currentAccount].avatar;
    }

    function initWeiboEvents() {
        document.getElementById('weibo-nav-home')?.addEventListener('click', () => {
            document.getElementById('weibo-home-view').classList.remove('hidden');
            document.getElementById('weibo-discover-view').classList.add('hidden');
            document.getElementById('weibo-profile-view').classList.add('hidden');
            document.getElementById('weibo-nav-home').classList.add('text-orange-500');
            document.getElementById('weibo-nav-home').classList.remove('text-gray-500');
            document.getElementById('weibo-nav-discover').classList.add('text-gray-500');
            document.getElementById('weibo-nav-discover').classList.remove('text-orange-500');
            document.getElementById('weibo-nav-profile').classList.add('text-gray-500');
            document.getElementById('weibo-nav-profile').classList.remove('text-orange-500');
        });
        document.getElementById('weibo-nav-discover')?.addEventListener('click', () => {
            document.getElementById('weibo-home-view').classList.add('hidden');
            document.getElementById('weibo-discover-view').classList.remove('hidden');
            document.getElementById('weibo-profile-view').classList.add('hidden');
            document.getElementById('weibo-nav-home').classList.add('text-gray-500');
            document.getElementById('weibo-nav-home').classList.remove('text-orange-500');
            document.getElementById('weibo-nav-discover').classList.add('text-orange-500');
            document.getElementById('weibo-nav-discover').classList.remove('text-gray-500');
            document.getElementById('weibo-nav-profile').classList.add('text-gray-500');
            document.getElementById('weibo-nav-profile').classList.remove('text-orange-500');
            renderHotTopics();
        });
        document.getElementById('weibo-nav-profile')?.addEventListener('click', () => {
            document.getElementById('weibo-home-view').classList.add('hidden');
            document.getElementById('weibo-discover-view').classList.add('hidden');
            document.getElementById('weibo-profile-view').classList.remove('hidden');
            document.getElementById('weibo-nav-home').classList.add('text-gray-500');
            document.getElementById('weibo-nav-home').classList.remove('text-orange-500');
            document.getElementById('weibo-nav-discover').classList.add('text-gray-500');
            document.getElementById('weibo-nav-discover').classList.remove('text-orange-500');
            document.getElementById('weibo-nav-profile').classList.add('text-orange-500');
            document.getElementById('weibo-nav-profile').classList.remove('text-gray-500');
            updateWeiboProfile();
        });
        document.getElementById('weibo-recommend-tab')?.addEventListener('click', () => {
            document.getElementById('weibo-recommend-content').classList.remove('hidden');
            document.getElementById('weibo-follow-content').classList.add('hidden');
            document.getElementById('weibo-recommend-tab').classList.add('text-orange-500', 'border-b-2', 'border-orange-500');
            document.getElementById('weibo-recommend-tab').classList.remove('text-gray-500');
            document.getElementById('weibo-follow-tab').classList.add('text-gray-500');
            document.getElementById('weibo-follow-tab').classList.remove('text-orange-500', 'border-b-2', 'border-orange-500');
        });
        document.getElementById('weibo-follow-tab')?.addEventListener('click', () => {
            document.getElementById('weibo-recommend-content').classList.add('hidden');
            document.getElementById('weibo-follow-content').classList.remove('hidden');
            document.getElementById('weibo-follow-tab').classList.add('text-orange-500', 'border-b-2', 'border-orange-500');
            document.getElementById('weibo-follow-tab').classList.remove('text-gray-500');
            document.getElementById('weibo-recommend-tab').classList.add('text-gray-500');
            document.getElementById('weibo-recommend-tab').classList.remove('text-orange-500', 'border-b-2', 'border-orange-500');
            refreshFollowPosts();
        });
        document.getElementById('weibo-refresh-btn')?.addEventListener('click', () => {
    if (!document.getElementById('weibo-recommend-content').classList.contains('hidden')) {
        refreshRecommendPosts();
    } else {
        refreshFollowPosts();
    }
});
        document.getElementById('weibo-follow-manage-btn')?.addEventListener('click', () => {
            loadFollowedAIs();
            document.getElementById('weibo-follow-ai-modal').classList.remove('hidden');
        });
        document.getElementById('weibo-follow-ai-close')?.addEventListener('click', () => document.getElementById('weibo-follow-ai-modal').classList.add('hidden'));
        document.getElementById('weibo-post-btn')?.addEventListener('click', () => document.getElementById('weibo-post-modal').classList.remove('hidden'));
        document.getElementById('weibo-post-cancel')?.addEventListener('click', () => document.getElementById('weibo-post-modal').classList.add('hidden'));
        document.getElementById('weibo-post-publish')?.addEventListener('click', publishWeibo);
        document.getElementById('weibo-ai-generate')?.addEventListener('click', async () => {
            const generateBtn = document.getElementById('weibo-ai-generate');
            const textarea = document.getElementById('weibo-post-textarea');
            generateBtn.textContent = 'ç”Ÿæˆä¸­...';
            generateBtn.disabled = true;
            try {
                const content = await generateMyWeiboContent();
                if (content) textarea.value = content;
                else showToast('ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥APIè®¾ç½®', 'error');
            } catch (error) {
                showToast('ç”Ÿæˆå¤±è´¥ï¼š' + error.message, 'error');
            }
            generateBtn.textContent = 'AIç”Ÿæˆ';
            generateBtn.disabled = false;
        });
        document.getElementById('weibo-detail-back')?.addEventListener('click', () => {
            document.getElementById('weibo-detail-view').classList.add('hidden');
            document.getElementById('weibo-main-view').classList.remove('hidden');
        });
        document.getElementById('weibo-comment-send')?.addEventListener('click', sendWeiboComment);
        document.getElementById('weibo-comment-input')?.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendWeiboComment(); });
        document.getElementById('weibo-switch-account-btn')?.addEventListener('click', () => {
            renderAccountList();
            document.getElementById('weibo-account-modal').classList.remove('hidden');
        });
        document.getElementById('weibo-add-account-btn')?.addEventListener('click', addWeiboAccount);
        document.getElementById('weibo-account-close')?.addEventListener('click', () => document.getElementById('weibo-account-modal').classList.add('hidden'));
        document.getElementById('weibo-profile-avatar')?.addEventListener('click', uploadWeiboAvatar);
        document.getElementById('weibo-profile-name')?.addEventListener('change', (e) => { weiboData.accounts[weiboData.currentAccount].name = e.target.value; saveWeiboData(); });
        document.getElementById('weibo-profile-signature')?.addEventListener('change', (e) => { weiboData.accounts[weiboData.currentAccount].signature = e.target.value; saveWeiboData(); });
        document.getElementById('weibo-ai-list')?.addEventListener('click', (e) => { if (e.target.classList.contains('weibo-follow-toggle-btn')) toggleFollowAI(parseInt(e.target.dataset.contactId)); });
        document.getElementById('weibo-account-list')?.addEventListener('click', (e) => { if (e.target.classList.contains('weibo-switch-account-btn')) switchWeiboAccount(e.target.dataset.accountId); });
        document.getElementById('weibo-recommend-content')?.addEventListener('click', (e) => {
            if (e.target.closest('.weibo-like-btn')) {
                const btn = e.target.closest('.weibo-like-btn');
                const postId = parseFloat(btn.dataset.postId);
                const post = weiboData.recommendPosts.find(p => p.id === postId);
                if (post) {
                    post.likes++;
                    btn.querySelector('span:last-child').textContent = post.likes;
                }
            }
        });
    }

    function renderHotTopics() {
        const container = document.getElementById('weibo-hot-topics');
        container.innerHTML = weiboData.hotTopics.map((topic, index) => `<div class="bg-white rounded-lg p-4 shadow-sm flex justify-between items-center cursor-pointer hover:bg-gray-50" onclick="alert('æ‰“å¼€çƒ­é—¨è¯é¢˜ï¼š${topic.title}')"><div><div class="text-sm text-gray-500">${index + 1}</div><div class="font-bold">${topic.title}</div><div class="text-xs text-gray-400">${topic.heat} é˜…è¯»</div></div><span class="text-2xl">ğŸ”¥</span></div>`).join('');
    }

        async function refreshFollowPosts() {
        const container = document.getElementById('weibo-follow-list');
        container.innerHTML = '<div class="text-center py-8 text-gray-500">æ­£åœ¨åˆ·æ–°...</div>';

        if (weiboData.followedAIs.length === 0) {
            container.innerHTML = '<div class="text-center py-8 text-gray-400">è¿˜æ²¡æœ‰å…³æ³¨ä»»ä½•äºº</div>';
            return;
        }

        try {
        // å…³é”®ä¿®æ­£ï¼šåªä¼ é€’ä½ å…³æ³¨çš„AIåˆ—è¡¨
        const followed_ai_list = weiboData.followedAIs.map(ai => {
            const contact = state.contacts.find(c => c.id === ai.id);
            return {
                id: ai.id,
                name: ai.name,
                persona: contact?.persona || 'ä¸€ä¸ªå·²å…³æ³¨çš„AI',
                is_public_figure: true // å…³æ³¨çš„äººé»˜è®¤æœ‰ä¸€å®šå…¬å¼€åº¦
            };
        });

        // é—®é¢˜åœ¨è¿™é‡Œï¼
        let responseText = await fetchAIResponse('weibo_follow', { followed_ai_list });
            const jsonMatch = responseText.match(/```json\s*([\s\S]*?)\s*```/);
            if (jsonMatch && jsonMatch[1]) {
                responseText = jsonMatch[1];
            }

            const posts = JSON.parse(responseText);
            // å°†ç”Ÿæˆçš„å†…å®¹ç›´æ¥æ¸²æŸ“åˆ°å…³æ³¨åˆ—è¡¨
            container.innerHTML = posts.map(p => createWeiboPostElement({ ...p, id: Date.now() + Math.random(), commentList: [] }).outerHTML).join('');

        } catch (error) {
            console.error("å…³æ³¨é¡µåˆ·æ–°å¤±è´¥:", error);
            container.innerHTML = `<div class="text-center py-8 text-red-500">åˆ·æ–°å¤±è´¥: ${error.message}</div>`;
        }
    }

    function loadFollowedAIs() {
        const container = document.getElementById('weibo-ai-list');
        container.innerHTML = state.contacts.map(contact => {
            const isFollowed = weiboData.followedAIs.some(ai => ai.id === contact.id);
            return `<div class="flex items-center justify-between p-3 border rounded-lg"><div class="flex items-center"><img src="${contact.avatar || 'https://i.postimg.cc/Fs8RPSdF/image.png'}" class="w-12 h-12 rounded-full mr-3 object-cover"><span class="font-bold">${contact.name}</span></div><button class="weibo-follow-toggle-btn ${isFollowed ? 'bg-gray-300' : 'bg-orange-500'} text-white px-4 py-1 rounded-full text-sm" data-contact-id="${contact.id}">${isFollowed ? 'å·²å…³æ³¨' : 'å…³æ³¨'}</button></div>`;
        }).join('');
    }

    function toggleFollowAI(contactId) {
        const contact = state.contacts.find(c => c.id === contactId);
        if (!contact) return;
        const index = weiboData.followedAIs.findIndex(ai => ai.id === contactId);
        if (index > -1) {
            weiboData.followedAIs.splice(index, 1);
        } else {
            weiboData.followedAIs.push({ id: contact.id, name: contact.name, avatar: contact.avatar });
        }
        saveWeiboData();
        loadFollowedAIs();
        updateWeiboProfile();
    }

    init();
});
</script>

</body>
</html>